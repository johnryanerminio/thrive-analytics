<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Thrive Analytics</title>

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,300;0,9..40,400;0,9..40,500;0,9..40,600;0,9..40,700&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Chart.js 4.4.6 (self-hosted — pinned version, no CDN dependency) -->
  <script src="/chart.min.js"></script>
  <!-- Alpine.js 3 -->
  <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3/dist/cdn.min.js"></script>

  <!-- Tailwind Config -->
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary:     { DEFAULT: '#f8fafc', dark: '#ffffff' },
            gold:        { DEFAULT: '#c8956c', light: 'rgba(200,149,108,0.15)' },
            success:     { DEFAULT: '#22c55e' },
            destructive: { DEFAULT: '#a8555a' },
            cream:       { DEFAULT: '#0f1117' },
            card:        { DEFAULT: '#13151d' },
            muted:       { DEFAULT: '#1e293b' },
            warning:     { DEFAULT: '#c49357' },
          },
          fontFamily: {
            sans: ['DM Sans', 'system-ui', '-apple-system', 'sans-serif'],
            mono: ['JetBrains Mono', 'SF Mono', 'monospace'],
          },
        },
      },
    }
  </script>

  <!-- Custom Styles -->
  <style>
    :root {
      --bg-primary: #0f1117;
      --bg-card: #13151d;
      --bg-card-alt: #161922;
      --bg-header: #0f1117;
      --bg-row-alt: rgba(255,255,255,0.015);
      --bg-hover: rgba(200,149,108,0.06);
      --bg-sidebar: #0b0d12;
      --border-primary: #1e293b;
      --border-subtle: rgba(30,41,59,0.5);
      --text-primary: #f8fafc;
      --text-secondary: #cbd5e1;
      --text-tertiary: #94a3b8;
      --text-muted: #64748b;
      --text-disabled: #475569;
      --accent-copper: #c8956c;
      --accent-copper-bg: rgba(200,149,108,0.06);
      --accent-copper-border: rgba(200,149,108,0.15);
      --color-positive: #22c55e;
      --color-negative: #a8555a;
      --color-warning: #c49357;
      --color-info: #3b82f6;
      --color-positive-bg: rgba(34,197,94,0.1);
      --color-negative-bg: rgba(239,68,68,0.1);
      --color-warning-bg: rgba(245,158,11,0.1);
    }

    [x-cloak] { display: none !important; }

    body {
      background: var(--bg-primary);
      font-family: 'DM Sans', system-ui, -apple-system, sans-serif;
      color: var(--text-secondary);
    }

    /* Sidebar */
    .sidebar {
      width: 260px;
      position: fixed;
      top: 0;
      left: 0;
      bottom: 0;
      background: var(--bg-sidebar);
      z-index: 40;
      display: flex;
      flex-direction: column;
      overflow-y: auto;
    }

    /* Top bar */
    .topbar {
      position: fixed;
      top: 0;
      left: 260px;
      right: 0;
      height: 64px;
      z-index: 30;
      background: var(--bg-card);
      border-bottom: 1px solid var(--border-primary);
      display: flex;
      align-items: center;
      padding: 0 24px;
    }

    /* Main content area */
    .main-content {
      margin-left: 260px;
      padding-top: 80px;
      padding-bottom: 40px;
      min-height: 100vh;
    }

    /* Scrollbar */
    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: var(--border-primary); border-radius: 3px; }
    ::-webkit-scrollbar-thumb:hover { background: #334155; }

    /* Sidebar nav item */
    .nav-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 10px 20px;
      border-radius: 8px;
      margin: 2px 12px;
      font-size: 14px;
      font-weight: 500;
      color: var(--text-tertiary);
      cursor: pointer;
      transition: all 0.15s ease;
    }
    .nav-item:hover {
      color: var(--text-secondary);
      background: rgba(255,255,255,0.04);
    }
    .nav-item.active {
      color: #fff;
      background: rgba(200,149,108,0.12);
      border-left: 3px solid var(--accent-copper);
      padding-left: 17px;
    }

    /* KPI card */
    .kpi-card {
      background: var(--bg-card-alt);
      border-radius: 12px;
      padding: 16px 18px;
      border: 1px solid var(--border-primary);
    }

    /* Chart container */
    .chart-container {
      background: var(--bg-card);
      border-radius: 12px;
      padding: 24px;
      border: 1px solid var(--border-primary);
    }

    /* Table styles */
    .data-table {
      width: 100%;
      border-collapse: collapse;
    }
    .data-table th {
      font-family: 'DM Sans', system-ui, sans-serif;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      color: var(--text-muted);
      padding: 10px 16px;
      border-bottom: 1px solid var(--border-primary);
      white-space: nowrap;
      background: var(--bg-header);
    }
    .data-table td {
      padding: 10px 16px;
      font-size: 13px;
      border-bottom: 1px solid var(--border-subtle);
      color: var(--text-secondary);
      font-family: 'JetBrains Mono', monospace;
    }
    .data-table td:first-child {
      font-family: 'DM Sans', system-ui, sans-serif;
    }
    .data-table tbody tr:nth-child(even) {
      background: var(--bg-row-alt);
    }
    .data-table tbody tr:hover {
      background: var(--bg-hover);
    }
    .data-table .total-row td {
      font-weight: 700;
      border-top: 2px solid var(--accent-copper);
      border-bottom: none;
      background: var(--accent-copper-bg);
      color: var(--text-primary);
    }

    /* Period picker */
    .picker-popover {
      position: absolute;
      top: 100%;
      right: 0;
      margin-top: 8px;
      background: var(--bg-card);
      border-radius: 12px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.4);
      border: 1px solid var(--border-primary);
      padding: 20px;
      z-index: 50;
      width: 420px;
    }

    /* Month button states */
    .month-btn {
      padding: 6px 4px;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.1s ease;
      text-align: center;
      color: var(--text-secondary);
    }
    .month-btn.selected {
      background: var(--accent-copper);
      color: #fff;
    }
    .month-btn.in-range {
      background: rgba(200,149,108,0.15);
      color: var(--text-primary);
    }
    .month-btn.no-data {
      opacity: 0.3;
      cursor: default;
    }
    .month-btn:not(.no-data):not(.selected):hover {
      background: rgba(200,149,108,0.08);
    }

    /* Insight card borders */
    .insight-success  { border-left: 4px solid var(--color-positive); }
    .insight-warning  { border-left: 4px solid var(--color-negative); }
    .insight-info     { border-left: 4px solid var(--accent-copper); }

    /* Loading overlay */
    .loading-overlay {
      position: absolute;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(15,17,23,0.7);
      border-radius: 12px;
      z-index: 10;
    }

    /* Delta pills */
    .delta-pill {
      display: inline-flex;
      align-items: center;
      gap: 3px;
      padding: 2px 8px;
      border-radius: 6px;
      font-size: 11px;
      font-weight: 600;
      font-family: 'JetBrains Mono', monospace;
    }
    .delta-pill.positive { background: var(--color-positive-bg); color: var(--color-positive); }
    .delta-pill.negative { background: var(--color-negative-bg); color: var(--color-negative); }
    .delta-pill.neutral  { background: rgba(255,255,255,0.05); color: var(--text-muted); }

    /* Metric tabs */
    .metric-tabs {
      display: flex;
      gap: 2px;
      background: var(--bg-card-alt);
      border-radius: 10px;
      padding: 4px;
      border: 1px solid var(--border-primary);
    }
    .metric-tab {
      padding: 8px 16px;
      border-radius: 8px;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.15s ease;
      color: var(--text-muted);
    }
    .metric-tab.active {
      background: var(--accent-copper);
      color: #0f1117;
      font-weight: 600;
    }
    .metric-tab:not(.active):hover {
      color: var(--text-secondary);
      background: rgba(255,255,255,0.04);
    }

    /* Spin animation */
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    .animate-spin {
      animation: spin 0.8s linear infinite;
    }

    /* ============================================================ */
    /* STICKY FIRST COLUMN — all screen sizes                       */
    /* ============================================================ */
    .data-table.sticky-col th:first-child,
    .data-table.sticky-col td:first-child {
      position: sticky;
      left: 0;
      z-index: 2;
      background: var(--bg-card);
      border-right: 1px solid var(--border-primary);
      min-width: 100px;
    }
    .data-table.sticky-col thead th:first-child {
      background: var(--bg-header);
      z-index: 3;
    }
    .data-table.sticky-col tbody tr:nth-child(even) td:first-child {
      background: var(--bg-card-alt);
    }
    .data-table.sticky-col tbody tr:hover td:first-child {
      background: #1a1d27;
    }
    .data-table.sticky-col .total-row td:first-child {
      background: var(--accent-copper-bg);
    }

    /* ============================================================ */
    /* RESPONSIVE: Mobile & Tablet                                  */
    /* ============================================================ */

    /* --- Tablet (768-1023px) --- */
    @media (max-width: 1023px) and (min-width: 768px) {
      .sidebar { width: 220px; }
      .topbar  { left: 220px; }
      .main-content { margin-left: 220px; }
      .loading-overlay-wrapper { margin-left: 220px !important; }
    }

    /* --- Mobile (<768px) --- */
    @media (max-width: 767px) {
      /* Sidebar: off-screen drawer */
      .sidebar {
        width: 280px;
        transform: translateX(-100%);
        transition: transform 0.25s ease;
        z-index: 60;
      }
      .sidebar.open { transform: translateX(0); }

      /* Backdrop behind sidebar */
      .sidebar-backdrop {
        position: fixed;
        inset: 0;
        background: rgba(0,0,0,0.5);
        z-index: 55;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.25s ease;
      }
      .sidebar-backdrop.visible {
        opacity: 1;
        pointer-events: auto;
      }

      /* Topbar: full width, add space for hamburger */
      .topbar {
        left: 0;
        padding: 0 12px;
        gap: 8px;
      }

      /* Main content: full width */
      .main-content {
        margin-left: 0;
        padding-top: 72px;
        padding-bottom: 24px;
      }
      .main-content.px-6 { padding-left: 12px; padding-right: 12px; }

      /* Hamburger button (visible only on mobile) */
      .hamburger-btn {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 44px;
        height: 44px;
        border-radius: 8px;
        color: var(--text-secondary);
        flex-shrink: 0;
      }
      .hamburger-btn:active { background: rgba(255,255,255,0.06); }

      /* Page title: truncate on mobile */
      .topbar h1 { font-size: 14px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 140px; }

      /* Period picker popover: full-width on mobile */
      .picker-popover { width: calc(100vw - 24px); right: -12px; max-width: 420px; }

      /* Font size floors */
      body { font-size: 14px; }
      .data-table td { font-size: 12px; padding: 8px 10px; }
      .data-table th { font-size: 10px; padding: 8px 10px; }

      /* KPI cards: slightly tighter on mobile */
      .kpi-card { padding: 12px 14px; }
      .kpi-card .text-2xl { font-size: 1.25rem; }

      /* Chart containers: tighter padding */
      .chart-container { padding: 16px; }

      /* Metric tabs: horizontally scrollable */
      .metric-tabs { overflow-x: auto; -webkit-overflow-scrolling: touch; flex-wrap: nowrap; }
      .metric-tab { white-space: nowrap; min-height: 44px; display: flex; align-items: center; }

      /* Loading overlay: full width */
      .loading-overlay-wrapper { margin-left: 0 !important; }

      /* Tap targets: minimum 44px for interactive elements */
      select, button, .nav-item, .month-btn {
        min-height: 44px;
      }
      .month-btn { min-height: 36px; } /* Grid is tight, 36px is acceptable */

      /* Flex items in topbar: wrap and stack on very small screens */
      .topbar .ml-auto { gap: 6px; }
    }

    /* Hide hamburger on desktop/tablet */
    @media (min-width: 768px) {
      .hamburger-btn { display: none; }
      .sidebar-backdrop { display: none; }
    }

    /* Print styles — light output */
    @media print {
      .sidebar, .topbar { display: none !important; }
      .main-content {
        margin-left: 0 !important;
        padding-top: 0 !important;
      }
      body { background: #fff !important; color: #1a1a1a !important; }
      .kpi-card, .chart-container {
        break-inside: avoid;
        background: #fff !important;
        border: 1px solid #ddd !important;
        color: #1a1a1a !important;
      }
      .data-table th { color: #666 !important; background: #f5f5f5 !important; border-color: #ddd !important; }
      .data-table td { color: #1a1a1a !important; border-color: #eee !important; }
      .data-table .total-row td { border-color: #c8956c !important; background: #faf6f1 !important; }
    }
  </style>
</head>

<body class="min-h-screen" x-data="dashboard()" x-init="init()">

  <!-- Mobile backdrop -->
  <div class="sidebar-backdrop" :class="sidebarOpen && 'visible'" @click="sidebarOpen = false"></div>

  <!-- ============================================================ -->
  <!-- SIDEBAR                                                       -->
  <!-- ============================================================ -->
  <aside class="sidebar" :class="sidebarOpen && 'open'">
    <!-- Logo -->
    <div class="flex items-center gap-3 px-5 py-5 border-b border-white/5">
      <img src="/logo.png" class="w-10 h-10" style="filter: brightness(0) invert(1)" alt="Thrive">
      <div>
        <div class="text-white font-bold text-sm tracking-wider">THRIVE</div>
        <div class="text-[#64748b] text-[11px] tracking-widest">ANALYTICS</div>
      </div>
    </div>

    <!-- Navigation -->
    <nav class="flex-1 py-4">
      <!-- Executive Summary -->
      <div class="nav-item" :class="view === 'executive' && 'active'"
           @click="switchView('executive')">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
          <rect x="3" y="3" width="7" height="7" rx="1"/>
          <rect x="14" y="3" width="7" height="7" rx="1"/>
          <rect x="3" y="14" width="7" height="7" rx="1"/>
          <rect x="14" y="14" width="7" height="7" rx="1"/>
        </svg>
        <span>Executive Summary</span>
      </div>

      <!-- Month-over-Month -->
      <div class="nav-item" :class="view === 'mom' && 'active'"
           @click="switchView('mom')">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
          <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/>
        </svg>
        <span>Month-over-Month</span>
      </div>

      <!-- Store Performance -->
      <div class="nav-item" :class="view === 'stores' && 'active'"
           @click="switchView('stores')">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
          <path d="M3 9l9-7 9 7v11a2 2 0 01-2 2H5a2 2 0 01-2-2z"/>
          <polyline points="9 22 9 12 15 12 15 22"/>
        </svg>
        <span>Store Performance</span>
      </div>

      <!-- Year-End Summary -->
      <div class="nav-item" :class="view === 'yearend' && 'active'"
           @click="switchView('yearend')">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
          <rect x="3" y="4" width="18" height="18" rx="2"/>
          <line x1="16" y1="2" x2="16" y2="6"/>
          <line x1="8" y1="2" x2="8" y2="6"/>
          <line x1="3" y1="10" x2="21" y2="10"/>
        </svg>
        <span>Year-End Summary</span>
      </div>

      <!-- Brand Reports -->
      <div class="nav-item" :class="view === 'brands' && 'active'"
           @click="switchView('brands')">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
          <path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83 0L2 12V2h10l8.59 8.59a2 2 0 010 2.82z"/>
          <line x1="7" y1="7" x2="7.01" y2="7"/>
        </svg>
        <span>Brand Reports</span>
      </div>

      <!-- Master Reports -->
      <div class="nav-item" :class="view === 'master' && 'active'"
           @click="switchView('master')">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
          <path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/>
          <polyline points="14 2 14 8 20 8"/>
          <line x1="16" y1="13" x2="8" y2="13"/>
          <line x1="16" y1="17" x2="8" y2="17"/>
          <polyline points="10 9 9 9 8 9"/>
        </svg>
        <span>Master Reports</span>
      </div>

      <!-- Data Manager -->
      <div class="nav-item" :class="view === 'datamanager' && 'active'"
           @click="switchView('datamanager')">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
          <ellipse cx="12" cy="5" rx="9" ry="3"/>
          <path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"/>
          <path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"/>
        </svg>
        <span>Data Manager</span>
      </div>
    </nav>

    <!-- Sidebar Footer -->
    <div class="px-5 py-4 border-t border-white/5 text-[11px] text-[#64748b] space-y-1"
         x-show="health" x-cloak>
      <div class="flex justify-between">
        <span>Rows</span>
        <span x-text="health ? Number(health.rows).toLocaleString() : ''"></span>
      </div>
      <div class="flex justify-between">
        <span>Stores</span>
        <span x-text="health?.stores"></span>
      </div>
      <div class="flex justify-between">
        <span>Brands</span>
        <span x-text="health?.brands"></span>
      </div>
    </div>
  </aside>

  <!-- ============================================================ -->
  <!-- TOP BAR                                                       -->
  <!-- ============================================================ -->
  <header class="topbar">
    <!-- Hamburger (mobile only) -->
    <button class="hamburger-btn" @click="sidebarOpen = !sidebarOpen" aria-label="Toggle menu">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round">
        <line x1="3" y1="6" x2="21" y2="6"/>
        <line x1="3" y1="12" x2="21" y2="12"/>
        <line x1="3" y1="18" x2="21" y2="18"/>
      </svg>
    </button>

    <!-- Page title -->
    <h1 class="text-lg font-semibold text-[#f8fafc]" x-text="pageTitle()"></h1>

    <div class="ml-auto flex items-center gap-2 md:gap-3 flex-shrink min-w-0">
      <!-- Brand search (only in brands view) -->
      <div class="relative" x-show="view === 'brands'" x-cloak>
        <input type="text"
               x-model="brandSearch"
               @input="showBrandDD = brandSearch.length > 0"
               @focus="showBrandDD = brandSearch.length > 0"
               @click.outside="showBrandDD = false"
               placeholder="Search brands..."
               class="w-36 md:w-56 px-3 py-2 text-sm border border-muted rounded-lg bg-[#161922] text-[#cbd5e1] placeholder-[#64748b] focus:outline-none focus:border-gold">
        <!-- Brand dropdown -->
        <div class="absolute top-full left-0 right-0 mt-1 bg-[#13151d] border border-muted rounded-lg shadow-lg max-h-64 overflow-y-auto z-50"
             x-show="showBrandDD && filteredBrands().length > 0" x-cloak>
          <template x-for="b in filteredBrands()" :key="b">
            <div class="px-3 py-2.5 text-sm cursor-pointer hover:bg-[rgba(200,149,108,0.06)] text-[#cbd5e1] flex items-center gap-1.5"
                 @click="selectedBrand = b; brandSearch = b; showBrandDD = false; loadBrandReport();">
              <span x-text="b"></span>
              <img x-show="internalBrands.has(b.toUpperCase())" src="/logo.png" class="w-4 h-4" style="filter: brightness(0) saturate(100%) invert(62%) sepia(30%) saturate(500%) hue-rotate(350deg) brightness(95%)" title="Thrive In-House Brand">
            </div>
          </template>
        </div>
      </div>

      <!-- Store filter -->
      <select x-model="selectedStore"
              @change="loadCurrentView()"
              class="hidden md:block px-3 py-2 text-sm border border-muted rounded-lg bg-[#161922] text-[#cbd5e1] focus:outline-none focus:border-gold">
        <option value="">All Stores</option>
        <template x-for="s in stores" :key="s">
          <option :value="s" x-text="s"></option>
        </template>
      </select>

      <!-- Period picker -->
      <div class="relative">
        <button @click="showPicker = !showPicker"
                class="flex items-center gap-1.5 md:gap-2 px-3 md:px-4 py-2 text-xs md:text-sm font-medium border border-muted rounded-lg bg-[#161922] text-[#cbd5e1] hover:border-gold transition-colors">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <rect x="3" y="4" width="18" height="18" rx="2"/>
            <line x1="16" y1="2" x2="16" y2="6"/>
            <line x1="8" y1="2" x2="8" y2="6"/>
            <line x1="3" y1="10" x2="21" y2="10"/>
          </svg>
          <span x-text="periodLabel || 'All Time'"></span>
          <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="6 9 12 15 18 9"/>
          </svg>
        </button>

        <!-- Period picker popover -->
        <div class="picker-popover" x-show="showPicker" x-cloak
             @click.outside="showPicker = false"
             x-transition:enter="transition ease-out duration-150"
             x-transition:enter-start="opacity-0 translate-y-1"
             x-transition:enter-end="opacity-100 translate-y-0"
             x-transition:leave="transition ease-in duration-100"
             x-transition:leave-start="opacity-100 translate-y-0"
             x-transition:leave-end="opacity-0 translate-y-1">

          <!-- Presets -->
          <div class="mb-4">
            <div class="text-xs font-semibold text-[#64748b] uppercase tracking-wider mb-2">Quick Select</div>
            <div class="flex flex-wrap gap-2">
              <template x-for="p in [
                {label:'All Time', type:'all'},
                {label:'YTD',      type:'ytd'},
                {label:'H1',       type:'h1'},
                {label:'H2',       type:'h2'},
                {label:'Q1',       type:'q1'},
                {label:'Q2',       type:'q2'},
                {label:'Q3',       type:'q3'},
                {label:'Q4',       type:'q4'}
              ]" :key="p.label">
                <button class="px-3 py-1 text-xs font-medium rounded-md border transition-colors"
                        :class="isPresetActive(p) ? 'bg-gold text-[#0f1117] border-gold' : 'border-muted text-[#94a3b8] hover:border-gold'"
                        @click="applyPreset(p)"
                        x-text="p.label"></button>
              </template>
            </div>
          </div>

          <!-- Month grid per year -->
          <div class="space-y-4 max-h-64 overflow-y-auto">
            <template x-for="yr in availableYears()" :key="yr">
              <div>
                <div class="text-xs font-semibold text-[#94a3b8] mb-2" x-text="yr"></div>
                <div class="grid grid-cols-6 gap-1">
                  <template x-for="m in 12" :key="m">
                    <div class="month-btn"
                         :class="monthClass(yr, m)"
                         @click="pickMonth(yr, m)"
                         x-text="monthAbbr(m)"></div>
                  </template>
                </div>
              </div>
            </template>
          </div>

          <!-- Footer -->
          <div class="flex items-center justify-between mt-4 pt-3 border-t border-muted">
            <div class="text-xs text-[#64748b]">
              <span x-show="pickStart" x-text="pickStart ? (pickStart.year + '-' + String(pickStart.month).padStart(2,'0')) : ''"></span>
              <span x-show="pickStart && pickEnd"> to </span>
              <span x-show="pickEnd" x-text="pickEnd ? (pickEnd.year + '-' + String(pickEnd.month).padStart(2,'0')) : ''"></span>
            </div>
            <div class="flex gap-2">
              <button @click="clearPeriod()"
                      class="px-3 py-1 text-xs text-[#94a3b8] hover:text-[#cbd5e1]">Clear</button>
              <button @click="applyPeriod()"
                      class="px-4 py-1 text-xs font-medium bg-gold text-[#0f1117] rounded-md hover:bg-gold/90">Apply</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </header>

  <!-- ============================================================ -->
  <!-- MAIN CONTENT                                                  -->
  <!-- ============================================================ -->
  <main class="main-content px-6">

    <!-- Mobile-only filter row (store selector visible on mobile) -->
    <div class="md:hidden flex flex-wrap gap-2 mb-4">
      <select x-model="selectedStore"
              @change="loadCurrentView()"
              class="flex-1 min-w-0 px-3 py-2 text-sm border border-muted rounded-lg bg-[#161922] text-[#cbd5e1] focus:outline-none focus:border-gold">
        <option value="">All Stores</option>
        <template x-for="s in stores" :key="s">
          <option :value="s" x-text="s"></option>
        </template>
      </select>
    </div>

    <!-- Loading overlay -->
    <div x-show="loading" x-cloak class="fixed inset-0 z-50 flex items-center justify-center bg-[rgba(15,17,23,0.8)] loading-overlay-wrapper" style="margin-left:260px">
      <div class="flex flex-col items-center gap-3">
        <svg class="animate-spin" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="#c8956c" stroke-width="2">
          <circle cx="12" cy="12" r="10" stroke-opacity="0.2"/>
          <path d="M12 2a10 10 0 019.8 8" stroke-linecap="round"/>
        </svg>
        <span class="text-sm text-[#94a3b8] font-medium">Loading...</span>
      </div>
    </div>

    <!-- Error banner -->
    <div x-show="error" x-cloak class="mb-4 p-4 bg-destructive/10 border border-destructive/30 rounded-lg text-sm text-destructive flex items-center gap-2">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <circle cx="12" cy="12" r="10"/>
        <line x1="15" y1="9" x2="9" y2="15"/>
        <line x1="9" y1="9" x2="15" y2="15"/>
      </svg>
      <span x-text="error"></span>
      <button @click="error = null" class="ml-auto text-destructive/60 hover:text-destructive">&times;</button>
    </div>

    <!-- ========================================================== -->
    <!-- EXECUTIVE SUMMARY PAGE                                      -->
    <!-- ========================================================== -->
    <section x-show="view === 'executive'" x-cloak>
      <template x-if="execData">
        <div>
          <!-- Period label -->
          <div class="mb-6 text-sm text-[#94a3b8] font-medium" x-text="execData.period_label"></div>

          <!-- 6 Hero KPI Cards -->
          <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4 mb-6">
            <!-- Revenue -->
            <div class="kpi-card">
              <div class="text-[11px] font-semibold uppercase tracking-wider text-[#64748b] mb-1">Revenue</div>
              <div class="text-2xl font-bold text-[#f8fafc] font-mono" x-text="fmtCurrency(execData.kpis?.total_revenue)"></div>
            </div>
            <!-- Profit -->
            <div class="kpi-card">
              <div class="text-[11px] font-semibold uppercase tracking-wider text-[#64748b] mb-1">Profit</div>
              <div class="text-2xl font-bold text-[#f8fafc] font-mono" x-text="fmtCurrency(execData.kpis?.net_profit)"></div>
            </div>
            <!-- Margin -->
            <div class="kpi-card">
              <div class="text-[11px] font-semibold uppercase tracking-wider text-[#64748b] mb-1">Margin</div>
              <div class="text-2xl font-bold text-[#f8fafc] font-mono" x-text="fmtPct(execData.kpis?.blended_margin)"></div>
            </div>
            <!-- Units -->
            <div class="kpi-card">
              <div class="text-[11px] font-semibold uppercase tracking-wider text-[#64748b] mb-1">Units Sold</div>
              <div class="text-2xl font-bold text-[#f8fafc] font-mono" x-text="fmtN(execData.kpis?.total_units)"></div>
            </div>
            <!-- Discounts (red) -->
            <div class="kpi-card">
              <div class="text-[11px] font-semibold uppercase tracking-wider text-[#64748b] mb-1">Discounts</div>
              <div class="text-2xl font-bold text-destructive" x-text="fmtCurrency(execData.kpis?.total_discounts)"></div>
            </div>
            <!-- Full Price % (red if <30%) -->
            <div class="kpi-card">
              <div class="text-[11px] font-semibold uppercase tracking-wider text-[#64748b] mb-1">Full Price %</div>
              <div class="text-2xl font-bold"
                   :class="(execData.kpis?.full_price_pct ?? 0) < 30 ? 'text-destructive' : 'text-primary'"
                   x-text="fmtPct(execData.kpis?.full_price_pct)"></div>
            </div>
          </div>

          <!-- 4 Secondary KPI Cards -->
          <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
            <!-- Avg Monthly Revenue -->
            <div class="kpi-card">
              <div class="text-[11px] font-semibold uppercase tracking-wider text-[#64748b] mb-1">Avg Monthly Rev</div>
              <div class="text-xl font-bold text-[#f8fafc] font-mono" x-text="fmtCurrency(execData.secondary_kpis?.avg_monthly_revenue)"></div>
            </div>
            <!-- Avg Monthly Profit -->
            <div class="kpi-card">
              <div class="text-[11px] font-semibold uppercase tracking-wider text-[#64748b] mb-1">Avg Monthly Profit</div>
              <div class="text-xl font-bold text-[#f8fafc] font-mono" x-text="fmtCurrency(execData.secondary_kpis?.avg_monthly_profit)"></div>
            </div>
            <!-- Best Month -->
            <div class="kpi-card">
              <div class="text-[11px] font-semibold uppercase tracking-wider text-[#64748b] mb-1">Best Month</div>
              <div class="text-lg font-bold text-success" x-text="execData.secondary_kpis?.best_month?.label || '-'"></div>
              <div class="text-xs text-[#64748b]" x-text="fmtCurrency(execData.secondary_kpis?.best_month?.revenue)"></div>
            </div>
            <!-- Worst Month -->
            <div class="kpi-card">
              <div class="text-[11px] font-semibold uppercase tracking-wider text-[#64748b] mb-1">Worst Month</div>
              <div class="text-lg font-bold text-destructive" x-text="execData.secondary_kpis?.worst_month?.label || '-'"></div>
              <div class="text-xs text-[#64748b]" x-text="fmtCurrency(execData.secondary_kpis?.worst_month?.revenue)"></div>
            </div>
          </div>

          <!-- Excluded Transactions Callout -->
          <div class="mb-6 p-4 bg-[#161922] border-l-[3px] border-l-warning border border-[#1e293b] rounded-lg flex items-start gap-3"
               x-show="execData.excluded_transactions" x-cloak>
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#c49357" stroke-width="2" class="mt-0.5 shrink-0">
              <circle cx="12" cy="12" r="10"/>
              <line x1="12" y1="8" x2="12" y2="12"/>
              <line x1="12" y1="16" x2="12.01" y2="16"/>
            </svg>
            <div>
              <div class="text-sm font-semibold text-[#f8fafc] mb-1">Excluded Transactions</div>
              <div class="text-xs text-[#94a3b8]">
                <span x-text="fmtN(execData.excluded_transactions?.total)"></span> non-regular transactions excluded
                (<span x-text="fmtCurrency(execData.excluded_transactions?.total_value)"></span> revenue).
                Types: <span x-text="(execData.excluded_transactions?.breakdown || []).map(b => b.type).join(', ')"></span>
              </div>
            </div>
          </div>

          <!-- Sales Mix Health Indicator -->
          <div class="mb-6 chart-container" x-show="execData.sales_mix" x-cloak>
            <div class="flex items-center justify-between mb-4">
              <h3 class="text-sm font-semibold text-primary">Sales Mix</h3>
              <span class="px-2 py-0.5 text-xs font-medium rounded-full"
                    :class="execData.sales_mix?.health === 'healthy'
                      ? 'bg-success/10 text-success'
                      : execData.sales_mix?.health === 'watch'
                        ? 'bg-gold/10 text-gold'
                        : 'bg-destructive/10 text-destructive'"
                    x-text="execData.sales_mix?.health || 'unknown'"></span>
            </div>
            <div class="flex flex-col sm:flex-row gap-4 sm:gap-6 sm:items-center">
              <!-- Full price bar -->
              <div class="flex-1">
                <div class="flex justify-between text-xs mb-1">
                  <span class="text-[#94a3b8]">Full Price</span>
                  <span class="font-semibold text-[#f8fafc] font-mono" x-text="fmtPct(execData.sales_mix?.full_price_pct)"></span>
                </div>
                <div class="h-3 bg-[#1e293b] rounded-full overflow-hidden">
                  <div class="h-full bg-success rounded-full transition-all" :style="'width:' + (execData.sales_mix?.full_price_pct || 0) + '%'"></div>
                </div>
              </div>
              <!-- Discounted bar -->
              <div class="flex-1">
                <div class="flex justify-between text-xs mb-1">
                  <span class="text-[#94a3b8]">Discounted</span>
                  <span class="font-semibold text-[#f8fafc] font-mono" x-text="fmtPct(execData.sales_mix?.discounted_pct)"></span>
                </div>
                <div class="h-3 bg-[#1e293b] rounded-full overflow-hidden">
                  <div class="h-full bg-destructive rounded-full transition-all" :style="'width:' + (execData.sales_mix?.discounted_pct || 0) + '%'"></div>
                </div>
              </div>
            </div>
          </div>

          <!-- Monthly Performance Combo Chart -->
          <div class="mb-6 chart-container">
            <h3 class="text-sm font-semibold text-[#f8fafc] mb-4">Monthly Performance</h3>
            <div class="relative" style="height:320px">
              <canvas id="chart-exec-trend"></canvas>
            </div>
          </div>

          <!-- Insights -->
          <div class="mb-6" x-show="execData.insights && execData.insights.length > 0" x-cloak>
            <h3 class="text-sm font-semibold text-[#f8fafc] mb-3">Insights</h3>
            <div class="space-y-2">
              <template x-for="(insight, idx) in (execData.insights || [])" :key="idx">
                <div class="p-3 bg-[#161922] rounded-lg text-sm"
                     :class="insight.type === 'success' ? 'insight-success' :
                             insight.type === 'warning' ? 'insight-warning' : 'insight-info'">
                  <span class="font-semibold" x-text="insight.title"></span>
                  <span class="text-[#94a3b8] ml-1" x-text="insight.detail"></span>
                </div>
              </template>
            </div>
          </div>

          <!-- Two charts side by side: Top Categories + Top Stores -->
          <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
            <!-- Top Categories -->
            <div class="chart-container">
              <h3 class="text-sm font-semibold text-[#f8fafc] mb-4">Top Categories</h3>
              <div class="relative" style="height:300px">
                <canvas id="chart-exec-categories"></canvas>
              </div>
            </div>

            <!-- Top Stores -->
            <div class="chart-container">
              <h3 class="text-sm font-semibold text-[#f8fafc] mb-4">Top Stores</h3>
              <div class="relative" style="height:300px">
                <canvas id="chart-exec-stores"></canvas>
              </div>
            </div>
          </div>
        </div>
      </template>

      <!-- Empty state -->
      <div x-show="!execData && !loading" x-cloak class="text-center py-20 text-[#475569]">
        <svg class="mx-auto mb-4" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" opacity="0.3">
          <rect x="3" y="3" width="7" height="7" rx="1"/>
          <rect x="14" y="3" width="7" height="7" rx="1"/>
          <rect x="3" y="14" width="7" height="7" rx="1"/>
          <rect x="14" y="14" width="7" height="7" rx="1"/>
        </svg>
        <div class="text-sm">Loading executive summary...</div>
      </div>
    </section>

    <!-- ========================================================== -->
    <!-- MONTH-OVER-MONTH PAGE                                       -->
    <!-- ========================================================== -->
    <section x-show="view === 'mom'" x-cloak x-data="{ momMetric: 'revenue' }">
      <div x-show="momData" x-cloak>
          <!-- Period label -->
          <div class="mb-6 text-sm text-[#94a3b8] font-medium" x-text="momData.period_label"></div>

          <!-- 3 KPI Cards -->
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
            <div class="kpi-card">
              <div class="text-[11px] font-semibold uppercase tracking-wider text-[#64748b] mb-1">Total Revenue</div>
              <div class="text-2xl font-bold text-[#f8fafc] font-mono" x-text="fmtCurrency(momData.totals?.revenue)"></div>
            </div>
            <div class="kpi-card">
              <div class="text-[11px] font-semibold uppercase tracking-wider text-[#64748b] mb-1">Avg Margin</div>
              <div class="text-2xl font-bold text-[#f8fafc] font-mono" x-text="fmtPct(momData.totals?.avg_margin)"></div>
            </div>
            <div class="kpi-card">
              <div class="text-[11px] font-semibold uppercase tracking-wider text-[#64748b] mb-1">Best Month</div>
              <div class="text-lg font-bold text-success" x-text="momData.best_month?.label || '-'"></div>
              <div class="text-xs text-[#64748b]" x-text="fmtCurrency(momData.best_month?.revenue)"></div>
            </div>
          </div>

          <!-- Year-over-Year Comparison (redesigned) -->
          <div x-show="momData.yoy_comparison && momData.yoy_comparison.length > 0" class="mb-6">

            <!-- Metric Tabs -->
            <div class="metric-tabs mb-6">
              <template x-for="tab in [{key:'revenue',label:'Revenue'},{key:'margin',label:'Margin'},{key:'profit',label:'Profit'},{key:'units',label:'Units'},{key:'full_price',label:'Full Price %'}]" :key="tab.key">
                <div class="metric-tab" :class="momMetric === tab.key && 'active'" @click="momMetric = tab.key" x-text="tab.label"></div>
              </template>
            </div>

            <!-- Annual Summary Cards -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6" x-show="momData.yoy_comparison?.length">
              <!-- Year 1 -->
              <div class="kpi-card">
                <div class="text-[11px] font-semibold uppercase tracking-wider text-[#64748b] mb-1" x-text="momData.yoy_comparison?.[0]?.y1 + ' Total'"></div>
                <div class="text-2xl font-bold text-[#94a3b8] font-mono"
                     x-text="momMetric === 'revenue' ? fmtCurrency(momData.yoy_comparison?.reduce((s,r) => s + (r.y1_revenue||0), 0)) :
                             momMetric === 'profit' ? fmtCurrency(momData.yoy_comparison?.reduce((s,r) => s + (r.y1_profit||0), 0)) :
                             momMetric === 'units' ? fmtN(momData.yoy_comparison?.reduce((s,r) => s + (r.y1_units||0), 0)) :
                             momMetric === 'margin' ? fmtPct(momData.yoy_comparison?.reduce((s,r) => s + (r.y1_margin||0), 0) / momData.yoy_comparison?.filter(r=>r.y1_margin!=null).length) :
                             fmtPct(momData.yoy_comparison?.reduce((s,r) => s + (r.y1_full_price_pct||0), 0) / momData.yoy_comparison?.filter(r=>r.y1_full_price_pct!=null).length)"></div>
              </div>
              <!-- Year 2 -->
              <div class="kpi-card">
                <div class="text-[11px] font-semibold uppercase tracking-wider text-[#64748b] mb-1" x-text="momData.yoy_comparison?.[0]?.y2 + ' Total'"></div>
                <div class="text-2xl font-bold text-[#f8fafc] font-mono"
                     x-text="momMetric === 'revenue' ? fmtCurrency(momData.yoy_comparison?.reduce((s,r) => s + (r.y2_revenue||0), 0)) :
                             momMetric === 'profit' ? fmtCurrency(momData.yoy_comparison?.reduce((s,r) => s + (r.y2_profit||0), 0)) :
                             momMetric === 'units' ? fmtN(momData.yoy_comparison?.reduce((s,r) => s + (r.y2_units||0), 0)) :
                             momMetric === 'margin' ? fmtPct(momData.yoy_comparison?.reduce((s,r) => s + (r.y2_margin||0), 0) / momData.yoy_comparison?.filter(r=>r.y2_margin!=null).length) :
                             fmtPct(momData.yoy_comparison?.reduce((s,r) => s + (r.y2_full_price_pct||0), 0) / momData.yoy_comparison?.filter(r=>r.y2_full_price_pct!=null).length)"></div>
              </div>
            </div>

            <!-- 12-Row Comparison Table -->
            <div class="chart-container mb-6 overflow-x-auto">
              <h3 class="text-sm font-semibold text-[#f8fafc] mb-4">
                <span x-text="momData.yoy_comparison?.[0]?.y1"></span> vs <span x-text="momData.yoy_comparison?.[0]?.y2"></span>
                — <span class="text-gold" x-text="{revenue:'Revenue',margin:'Margin',profit:'Profit',units:'Units',full_price:'Full Price %'}[momMetric]"></span>
              </h3>
              <table class="data-table sticky-col">
                <thead>
                  <tr>
                    <th>Month</th>
                    <th class="text-right" x-text="momData.yoy_comparison?.[0]?.y1"></th>
                    <th class="text-right" x-text="momData.yoy_comparison?.[0]?.y2"></th>
                    <th class="text-right">Change</th>
                  </tr>
                </thead>
                <tbody>
                  <template x-for="(row, idx) in (momData.yoy_comparison || [])" :key="idx">
                    <tr>
                      <td class="font-medium text-[#94a3b8]" x-text="row.month_label"></td>
                      <!-- Y1 value (dimmed) -->
                      <td class="text-right text-[#64748b]"
                          x-text="momMetric === 'revenue' ? (row.y1_revenue != null ? fmtCurrency(row.y1_revenue) : '-') :
                                  momMetric === 'profit' ? (row.y1_profit != null ? fmtCurrency(row.y1_profit) : '-') :
                                  momMetric === 'units' ? (row.y1_units != null ? fmtN(row.y1_units) : '-') :
                                  momMetric === 'margin' ? (row.y1_margin != null ? fmtPct(row.y1_margin) : '-') :
                                  (row.y1_full_price_pct != null ? fmtPct(row.y1_full_price_pct) : '-')"></td>
                      <!-- Y2 value (emphasized) -->
                      <td class="text-right font-semibold text-[#f8fafc]"
                          x-text="momMetric === 'revenue' ? (row.y2_revenue != null ? fmtCurrency(row.y2_revenue) : '-') :
                                  momMetric === 'profit' ? (row.y2_profit != null ? fmtCurrency(row.y2_profit) : '-') :
                                  momMetric === 'units' ? (row.y2_units != null ? fmtN(row.y2_units) : '-') :
                                  momMetric === 'margin' ? (row.y2_margin != null ? fmtPct(row.y2_margin) : '-') :
                                  (row.y2_full_price_pct != null ? fmtPct(row.y2_full_price_pct) : '-')"></td>
                      <!-- Delta pill -->
                      <td class="text-right">
                        <template x-if="momMetric === 'revenue' && row.revenue_change_pct != null">
                          <span class="delta-pill" :class="row.revenue_change_pct > 0 ? 'positive' : row.revenue_change_pct < 0 ? 'negative' : 'neutral'">
                            <span x-text="row.revenue_change_pct > 0 ? '\u25B2' : row.revenue_change_pct < 0 ? '\u25BC' : ''" style="font-size:8px"></span>
                            <span x-text="fmtPctSigned(row.revenue_change_pct)"></span>
                          </span>
                        </template>
                        <template x-if="momMetric === 'profit' && row.profit_change_pct != null">
                          <span class="delta-pill" :class="row.profit_change_pct > 0 ? 'positive' : row.profit_change_pct < 0 ? 'negative' : 'neutral'">
                            <span x-text="row.profit_change_pct > 0 ? '\u25B2' : row.profit_change_pct < 0 ? '\u25BC' : ''" style="font-size:8px"></span>
                            <span x-text="fmtPctSigned(row.profit_change_pct)"></span>
                          </span>
                        </template>
                        <template x-if="momMetric === 'margin' && row.margin_change_pts != null">
                          <span class="delta-pill" :class="row.margin_change_pts > 0 ? 'positive' : row.margin_change_pts < 0 ? 'negative' : 'neutral'">
                            <span x-text="row.margin_change_pts > 0 ? '\u25B2' : row.margin_change_pts < 0 ? '\u25BC' : ''" style="font-size:8px"></span>
                            <span x-text="(row.margin_change_pts > 0 ? '+' : '') + row.margin_change_pts + ' pts'"></span>
                          </span>
                        </template>
                        <template x-if="momMetric === 'units' && row.y1_units != null && row.y2_units != null">
                          <span class="delta-pill" :class="row.y2_units > row.y1_units ? 'positive' : row.y2_units < row.y1_units ? 'negative' : 'neutral'">
                            <span x-text="row.y2_units > row.y1_units ? '\u25B2' : row.y2_units < row.y1_units ? '\u25BC' : ''" style="font-size:8px"></span>
                            <span x-text="fmtPctSigned(row.y1_units ? ((row.y2_units - row.y1_units) / row.y1_units * 100) : 0)"></span>
                          </span>
                        </template>
                        <template x-if="momMetric === 'full_price' && row.full_price_change_pts != null">
                          <span class="delta-pill" :class="row.full_price_change_pts > 0 ? 'positive' : row.full_price_change_pts < 0 ? 'negative' : 'neutral'">
                            <span x-text="row.full_price_change_pts > 0 ? '\u25B2' : row.full_price_change_pts < 0 ? '\u25BC' : ''" style="font-size:8px"></span>
                            <span x-text="(row.full_price_change_pts > 0 ? '+' : '') + row.full_price_change_pts + ' pts'"></span>
                          </span>
                        </template>
                      </td>
                    </tr>
                  </template>
                </tbody>
              </table>
            </div>

            <!-- Dynamic Insight -->
            <div class="chart-container mb-6 border-l-[3px] border-l-gold" x-show="momData.yoy_comparison?.length > 0">
              <div class="text-sm text-[#cbd5e1]">
                <template x-if="momMetric === 'revenue'">
                  <span>Revenue
                    <span :class="momData.yoy_comparison?.reduce((s,r) => s + (r.y2_revenue||0), 0) >= momData.yoy_comparison?.reduce((s,r) => s + (r.y1_revenue||0), 0) ? 'text-success' : 'text-destructive'"
                          x-text="momData.yoy_comparison?.reduce((s,r) => s + (r.y2_revenue||0), 0) >= momData.yoy_comparison?.reduce((s,r) => s + (r.y1_revenue||0), 0) ? 'increased' : 'decreased'"></span>
                    year-over-year. The strongest month was
                    <span class="text-[#f8fafc] font-semibold" x-text="momData.yoy_comparison?.reduce((best, r) => (r.y2_revenue||0) > (best.y2_revenue||0) ? r : best, {})?.month_label"></span>.
                  </span>
                </template>
                <template x-if="momMetric === 'margin'">
                  <span>Margin trend shows the impact of pricing and cost management decisions across the year. Consistently higher margins in the current year indicate improved operational efficiency.</span>
                </template>
                <template x-if="momMetric === 'profit'">
                  <span>Profit performance reflects the combined effect of revenue and margin changes. Focus on months where profit diverges from revenue trends to identify margin opportunities.</span>
                </template>
                <template x-if="momMetric === 'units'">
                  <span>Unit volume tracks customer demand independent of price changes. Compare against revenue trends to understand whether growth is volume-driven or price-driven.</span>
                </template>
                <template x-if="momMetric === 'full_price'">
                  <span>Full price percentage measures how much revenue comes from non-discounted sales. Higher full price % generally correlates with better margins.</span>
                </template>
              </div>
            </div>

          </div>

          <!-- Monthly Breakdown Table (kept) -->
          <div class="chart-container mb-6 overflow-x-auto">
            <h3 class="text-sm font-semibold text-[#f8fafc] mb-4">Monthly Breakdown</h3>
            <table class="data-table sticky-col">
              <thead>
                <tr>
                  <th>Month</th>
                  <th class="text-right">Revenue</th>
                  <th class="text-right">Profit</th>
                  <th class="text-right">Margin</th>
                  <th class="text-right">Units</th>
                  <th class="text-right">FP %</th>
                </tr>
              </thead>
              <tbody>
                <template x-for="(row, idx) in (momData.months || [])" :key="idx">
                  <tr>
                    <td class="font-medium" x-text="row.label"></td>
                    <td class="text-right" x-text="fmtCurrency(row.revenue)"></td>
                    <td class="text-right" x-text="fmtCurrency(row.profit)"></td>
                    <td class="text-right" x-text="fmtPct(row.margin)"></td>
                    <td class="text-right" x-text="fmtN(row.units)"></td>
                    <td class="text-right" x-text="fmtPct(row.full_price_pct)"></td>
                  </tr>
                </template>
                <tr class="total-row" x-show="momData.totals">
                  <td class="font-bold">TOTAL</td>
                  <td class="text-right" x-text="fmtCurrency(momData.totals?.revenue)"></td>
                  <td class="text-right" x-text="fmtCurrency(momData.totals?.profit)"></td>
                  <td class="text-right" x-text="fmtPct(momData.totals?.avg_margin)"></td>
                  <td class="text-right" x-text="fmtN(momData.totals?.units)"></td>
                  <td class="text-right" x-text="fmtPct(momData.totals?.avg_full_price_pct)"></td>
                </tr>
              </tbody>
            </table>
          </div>
      </div>

      <!-- Empty state -->
      <div x-show="!momData && !loading" x-cloak class="text-center py-20 text-[#475569]">
        <svg class="mx-auto mb-4" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" opacity="0.3">
          <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/>
        </svg>
        <div class="text-sm">Loading month-over-month data...</div>
      </div>
    </section>

    <!-- ========================================================== -->
    <!-- STORE PERFORMANCE PAGE (START)                              -->
    <!-- ========================================================== -->
    <section x-show="view === 'stores'" x-cloak>
      <template x-if="storeData">
        <div>
          <!-- Period label -->
          <div class="mb-6 text-sm text-[#94a3b8] font-medium" x-text="storeData.period_label"></div>

          <!-- 4 KPI Cards -->
          <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
            <!-- Total Stores -->
            <div class="kpi-card">
              <div class="text-[11px] font-semibold uppercase tracking-wider text-[#64748b] mb-1">Stores</div>
              <div class="text-2xl font-bold text-[#f8fafc] font-mono" x-text="storeData.stores?.length || 0"></div>
            </div>
            <!-- Company Avg Margin -->
            <div class="kpi-card">
              <div class="text-[11px] font-semibold uppercase tracking-wider text-[#64748b] mb-1">Company Avg Margin</div>
              <div class="text-2xl font-bold text-[#f8fafc] font-mono" x-text="fmtPct(storeData.company_avg_margin)"></div>
            </div>
            <!-- Top Performer -->
            <div class="kpi-card">
              <div class="text-[11px] font-semibold uppercase tracking-wider text-[#64748b] mb-1">Top Performer</div>
              <div class="text-lg font-bold text-success truncate" x-text="storeData.top_performer || '-'"></div>
              <div class="text-xs text-[#64748b]" x-text="fmtCurrency(findStore(storeData, storeData.top_performer)?.revenue)"></div>
            </div>
            <!-- Bottom Performer -->
            <div class="kpi-card">
              <div class="text-[11px] font-semibold uppercase tracking-wider text-[#64748b] mb-1">Needs Attention</div>
              <div class="text-lg font-bold text-destructive truncate" x-text="storeData.bottom_performer || '-'"></div>
              <div class="text-xs text-[#64748b]" x-text="fmtCurrency(findStore(storeData, storeData.bottom_performer)?.revenue)"></div>
            </div>
          </div>

          <!-- Revenue by Store Horizontal Bar Chart -->
          <div class="mb-6 chart-container">
            <h3 class="text-sm font-semibold text-[#f8fafc] mb-4">Revenue by Store</h3>
            <div class="relative" style="height:320px">
              <canvas id="chart-store-revenue"></canvas>
            </div>
          </div>

          <!-- Top / Bottom Performers Side-by-Side -->
          <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
            <!-- Top Performer Card -->
            <div class="chart-container border-l-4 border-success">
              <div class="flex items-center gap-2 mb-3">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#22c55e" stroke-width="2">
                  <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/>
                </svg>
                <h3 class="text-sm font-semibold text-success">Top Performer</h3>
              </div>
              <div class="text-lg font-bold text-[#f8fafc] mb-1" x-text="storeData.top_performer || '-'"></div>
              <div class="grid grid-cols-3 gap-4 mt-3">
                <div>
                  <div class="text-[10px] uppercase text-[#64748b]">Revenue</div>
                  <div class="text-sm font-semibold" x-text="fmtCurrency(findStore(storeData, storeData.top_performer)?.revenue)"></div>
                </div>
                <div>
                  <div class="text-[10px] uppercase text-[#64748b]">Margin</div>
                  <div class="text-sm font-semibold" x-text="fmtPct(findStore(storeData, storeData.top_performer)?.margin)"></div>
                </div>
                <div>
                  <div class="text-[10px] uppercase text-[#64748b]">Units</div>
                  <div class="text-sm font-semibold" x-text="fmtN(findStore(storeData, storeData.top_performer)?.units)"></div>
                </div>
              </div>
            </div>

            <!-- Bottom Performer Card -->
            <div class="chart-container border-l-4 border-destructive">
              <div class="flex items-center gap-2 mb-3">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#a8555a" stroke-width="2">
                  <circle cx="12" cy="12" r="10"/>
                  <line x1="12" y1="8" x2="12" y2="12"/>
                  <line x1="12" y1="16" x2="12.01" y2="16"/>
                </svg>
                <h3 class="text-sm font-semibold text-destructive">Needs Attention</h3>
              </div>
              <div class="text-lg font-bold text-[#f8fafc] mb-1" x-text="storeData.bottom_performer || '-'"></div>
              <div class="grid grid-cols-3 gap-4 mt-3">
                <div>
                  <div class="text-[10px] uppercase text-[#64748b]">Revenue</div>
                  <div class="text-sm font-semibold" x-text="fmtCurrency(findStore(storeData, storeData.bottom_performer)?.revenue)"></div>
                </div>
                <div>
                  <div class="text-[10px] uppercase text-[#64748b]">Margin</div>
                  <div class="text-sm font-semibold" x-text="fmtPct(findStore(storeData, storeData.bottom_performer)?.margin)"></div>
                </div>
                <div>
                  <div class="text-[10px] uppercase text-[#64748b]">Units</div>
                  <div class="text-sm font-semibold" x-text="fmtN(findStore(storeData, storeData.bottom_performer)?.units)"></div>
                </div>
              </div>
            </div>
          </div>

          <!-- All Stores Table -->
          <div class="chart-container mb-6 overflow-x-auto">
            <h3 class="text-sm font-semibold text-[#f8fafc] mb-4">All Stores</h3>
            <table class="data-table sticky-col">
              <thead>
                <tr>
                  <th>Rank</th>
                  <th>Store</th>
                  <th class="text-right">Revenue</th>
                  <th class="text-right">Share %</th>
                  <th class="text-right">Profit</th>
                  <th class="text-right">Margin</th>
                  <th class="text-right">Units</th>
                  <th class="text-right">FP %</th>
                  <th>Top Brand</th>
                  <th>Top Category</th>
                </tr>
              </thead>
              <tbody>
                <template x-for="(s, idx) in (storeData.stores || [])" :key="idx">
                  <tr>
                    <td class="text-center font-medium" x-text="s.rank || (idx + 1)"></td>
                    <td class="font-medium" x-text="s.name"></td>
                    <td class="text-right" x-text="fmtCurrency(s.revenue)"></td>
                    <td class="text-right" x-text="fmtPct(s.share_pct)"></td>
                    <td class="text-right" x-text="fmtCurrency(s.profit)"></td>
                    <td class="text-right">
                      <span class="inline-flex items-center gap-1">
                        <span class="w-2 h-2 rounded-full"
                              :class="s.margin_status === 'green' ? 'bg-[#22c55e]' :
                                      s.margin_status === 'red' ? 'bg-[#a8555a]' : 'bg-[#c49357]'"></span>
                        <span x-text="fmtPct(s.margin)"></span>
                      </span>
                    </td>
                    <td class="text-right" x-text="fmtN(s.units)"></td>
                    <td class="text-right" x-text="fmtPct(s.full_price_pct)"></td>
                    <td class="text-xs truncate max-w-[120px]" x-text="s.top_brand || '-'"></td>
                    <td class="text-xs truncate max-w-[120px]" x-text="s.top_category || '-'"></td>
                  </tr>
                </template>
              </tbody>
            </table>
          </div>
        </div>
      </template>

      <!-- Empty state -->
      <div x-show="!storeData && !loading" x-cloak class="text-center py-20 text-[#475569]">
        <svg class="mx-auto mb-4" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" opacity="0.3">
          <path d="M3 9l9-7 9 7v11a2 2 0 01-2 2H5a2 2 0 01-2-2z"/>
          <polyline points="9 22 9 12 15 12 15 22"/>
        </svg>
        <div class="text-sm">Loading store performance data...</div>
      </div>
    </section>

    <!-- ========================================================== -->
    <!-- YEAR-END SUMMARY PAGE                                       -->
    <!-- ========================================================== -->
    <section x-show="view === 'yearend'" x-cloak class="print-section">
      <template x-if="yearEndData">
        <div>
          <!-- Year selector + Print -->
          <div class="flex items-center gap-3 mb-6">
            <select x-model.number="yearEndYear" @change="loadYearEnd()"
                    class="px-3 py-2 text-sm border border-muted rounded-lg bg-[#161922] text-[#cbd5e1] focus:outline-none focus:border-gold">
              <template x-for="y in availableYears()" :key="y">
                <option :value="y" x-text="y"></option>
              </template>
            </select>
            <button @click="window.print()"
                    class="px-4 py-2 md:py-1.5 text-sm font-medium bg-gold text-[#0f1117] rounded-lg hover:bg-gold/90 transition-colors flex items-center gap-2">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <polyline points="6 9 6 2 18 2 18 9"/>
                <path d="M6 18H4a2 2 0 01-2-2v-5a2 2 0 012-2h16a2 2 0 012 2v5a2 2 0 01-2 2h-2"/>
                <rect x="6" y="14" width="12" height="8"/>
              </svg>
              Print Report
            </button>
          </div>

          <!-- Company Header -->
          <div class="mb-6 p-5 bg-[#161922] border border-[#1e293b] rounded-xl">
            <div class="text-lg font-bold tracking-wide text-[#f8fafc]">Thrive Cannabis</div>
            <div class="text-gold text-sm font-semibold mt-1" x-text="yearEndYear + ' Annual Performance Report'"></div>
            <div class="text-[#64748b] text-xs mt-2">
              <span x-text="yearEndData.header?.stores || 0"></span> Stores &middot;
              <span x-text="yearEndData.header?.brands || 0"></span> Brands &middot;
              <span x-text="yearEndData.header?.months || 0"></span> Months
            </div>
          </div>

          <!-- 4 Hero KPI Cards -->
          <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
            <!-- Revenue -->
            <div class="kpi-card">
              <div class="text-[11px] font-semibold uppercase tracking-wider text-[#64748b] mb-1">Total Revenue</div>
              <div class="text-2xl font-bold text-[#f8fafc] font-mono" x-text="fmtCurrency(yearEndData.kpis?.total_revenue)"></div>
              <div class="text-xs text-[#64748b] mt-1">Avg/Mo: <span x-text="fmtCurrency(yearEndData.kpis?.avg_monthly_revenue)"></span></div>
            </div>
            <!-- Profit -->
            <div class="kpi-card">
              <div class="text-[11px] font-semibold uppercase tracking-wider text-[#64748b] mb-1">Total Profit</div>
              <div class="text-2xl font-bold text-[#f8fafc] font-mono" x-text="fmtCurrency(yearEndData.kpis?.total_profit)"></div>
              <div class="text-xs text-[#64748b] mt-1">Avg/Mo: <span x-text="fmtCurrency(yearEndData.kpis?.avg_monthly_profit)"></span></div>
            </div>
            <!-- Margin -->
            <div class="kpi-card">
              <div class="text-[11px] font-semibold uppercase tracking-wider text-[#64748b] mb-1">Blended Margin</div>
              <div class="text-2xl font-bold text-[#f8fafc] font-mono" x-text="fmtPct(yearEndData.kpis?.blended_margin)"></div>
              <div class="text-xs text-[#64748b] mt-1">FP: <span x-text="fmtPct(yearEndData.kpis?.full_price_pct)"></span></div>
            </div>
            <!-- Units -->
            <div class="kpi-card">
              <div class="text-[11px] font-semibold uppercase tracking-wider text-[#64748b] mb-1">Total Units</div>
              <div class="text-2xl font-bold text-[#f8fafc] font-mono" x-text="fmtN(yearEndData.kpis?.total_units)"></div>
              <div class="text-xs text-[#64748b] mt-1">Discounts: <span class="text-destructive" x-text="fmtCurrency(yearEndData.kpis?.total_discounts)"></span></div>
            </div>
          </div>

          <!-- Monthly Performance Trend Chart -->
          <div class="mb-6 chart-container">
            <h3 class="text-sm font-semibold text-[#f8fafc] mb-4">Monthly Performance Trend</h3>
            <div class="relative" style="height:320px">
              <canvas id="chart-yearend-trend"></canvas>
            </div>
          </div>

          <!-- Performance Highlights -->
          <div class="mb-6" x-show="yearEndData.highlights">
            <h3 class="text-sm font-semibold text-[#f8fafc] mb-3">Performance Highlights</h3>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
              <!-- Best Revenue Month -->
              <div class="kpi-card border-l-4 border-success">
                <div class="text-[10px] uppercase text-[#64748b] mb-1">Best Revenue Month</div>
                <div class="text-lg font-bold text-success" x-text="yearEndData.highlights?.best_revenue?.label || '-'"></div>
                <div class="text-xs text-[#94a3b8]" x-text="fmtCurrency(yearEndData.highlights?.best_revenue?.value)"></div>
              </div>
              <!-- Best Profit Month -->
              <div class="kpi-card border-l-4 border-success">
                <div class="text-[10px] uppercase text-[#64748b] mb-1">Best Profit Month</div>
                <div class="text-lg font-bold text-success" x-text="yearEndData.highlights?.best_profit?.label || '-'"></div>
                <div class="text-xs text-[#94a3b8]" x-text="fmtCurrency(yearEndData.highlights?.best_profit?.value)"></div>
              </div>
              <!-- Best Margin Month -->
              <div class="kpi-card border-l-4 border-success">
                <div class="text-[10px] uppercase text-[#64748b] mb-1">Best Margin Month</div>
                <div class="text-lg font-bold text-success" x-text="yearEndData.highlights?.best_margin?.label || '-'"></div>
                <div class="text-xs text-[#94a3b8]" x-text="fmtPct(yearEndData.highlights?.best_margin?.value)"></div>
              </div>
              <!-- Worst Profit Month -->
              <div class="kpi-card border-l-4 border-destructive">
                <div class="text-[10px] uppercase text-[#64748b] mb-1">Worst Profit Month</div>
                <div class="text-lg font-bold text-destructive" x-text="yearEndData.highlights?.worst_profit?.label || '-'"></div>
                <div class="text-xs text-[#94a3b8]" x-text="fmtCurrency(yearEndData.highlights?.worst_profit?.value)"></div>
              </div>
            </div>
          </div>

          <!-- Key Insights -->
          <div class="mb-6" x-show="yearEndData.key_insights && yearEndData.key_insights.length > 0" x-cloak>
            <h3 class="text-sm font-semibold text-[#f8fafc] mb-3">Key Insights</h3>
            <div class="space-y-2">
              <template x-for="(insight, idx) in (yearEndData.key_insights || [])" :key="idx">
                <div class="p-3 bg-[#161922] rounded-lg text-sm"
                     :class="insight.type === 'success' ? 'insight-success' :
                             insight.type === 'warning' ? 'insight-warning' : 'insight-info'">
                  <span class="font-semibold" x-text="insight.title"></span>
                  <span class="text-[#94a3b8] ml-1" x-text="insight.detail"></span>
                </div>
              </template>
            </div>
          </div>

          <!-- Year-over-Year Comparison -->
          <div class="mb-6" x-show="yearEndData.yoy_comparison" x-cloak>
            <h3 class="text-sm font-semibold text-[#f8fafc] mb-3">Year-over-Year Comparison vs <span x-text="yearEndData.yoy_comparison?.prev_year"></span></h3>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
              <!-- Revenue Change -->
              <div class="kpi-card">
                <div class="text-[11px] font-semibold uppercase tracking-wider text-[#64748b] mb-1">Revenue</div>
                <div class="text-2xl font-bold"
                     :class="(yearEndData.yoy_comparison?.revenue_change_pct ?? 0) >= 0 ? 'text-success' : 'text-destructive'"
                     x-text="fmtPctSigned(yearEndData.yoy_comparison?.revenue_change_pct)"></div>
                <div class="text-[11px] text-[#64748b] mt-1">
                  <span x-text="fmtCurrency(yearEndData.yoy_comparison?.prev_revenue)"></span>
                  <span class="mx-0.5">&rarr;</span>
                  <span x-text="fmtCurrency(yearEndData.kpis?.total_revenue)"></span>
                </div>
              </div>
              <!-- Margin Change -->
              <div class="kpi-card">
                <div class="text-[11px] font-semibold uppercase tracking-wider text-[#64748b] mb-1">Margin</div>
                <div class="text-2xl font-bold"
                     :class="(yearEndData.yoy_comparison?.margin_change_pts ?? 0) >= 0 ? 'text-success' : 'text-destructive'"
                     x-text="((yearEndData.yoy_comparison?.margin_change_pts ?? 0) > 0 ? '+' : '') + (yearEndData.yoy_comparison?.margin_change_pts ?? 0).toFixed(1) + ' pts'"></div>
                <div class="text-[11px] text-[#64748b] mt-1">
                  <span x-text="(yearEndData.yoy_comparison?.margin_prev ?? 0).toFixed(1) + '%'"></span>
                  <span class="mx-0.5">&rarr;</span>
                  <span x-text="(yearEndData.yoy_comparison?.margin_current ?? 0).toFixed(1) + '%'"></span>
                </div>
              </div>
              <!-- Profit Change -->
              <div class="kpi-card">
                <div class="text-[11px] font-semibold uppercase tracking-wider text-[#64748b] mb-1">Profit</div>
                <div class="text-2xl font-bold"
                     :class="(yearEndData.yoy_comparison?.profit_change_pct ?? 0) >= 0 ? 'text-success' : 'text-destructive'"
                     x-text="fmtPctSigned(yearEndData.yoy_comparison?.profit_change_pct)"></div>
                <div class="text-[11px] text-[#64748b] mt-1">
                  <span x-text="fmtCurrency(yearEndData.yoy_comparison?.prev_profit)"></span>
                  <span class="mx-0.5">&rarr;</span>
                  <span x-text="fmtCurrency(yearEndData.kpis?.total_profit)"></span>
                </div>
              </div>
              <!-- Revenue per Unit -->
              <div class="kpi-card">
                <div class="text-[11px] font-semibold uppercase tracking-wider text-[#64748b] mb-1">Revenue / Unit</div>
                <div class="text-2xl font-bold"
                     :class="(yearEndData.yoy_comparison?.rev_per_unit_change_pct ?? 0) >= 0 ? 'text-success' : 'text-destructive'"
                     x-text="fmtPctSigned(yearEndData.yoy_comparison?.rev_per_unit_change_pct)"></div>
                <div class="text-[11px] text-[#64748b] mt-1">
                  <span x-text="'$' + (yearEndData.yoy_comparison?.rev_per_unit_prev ?? 0).toFixed(2)"></span>
                  <span class="mx-0.5">&rarr;</span>
                  <span x-text="'$' + (yearEndData.yoy_comparison?.rev_per_unit_current ?? 0).toFixed(2)"></span>
                </div>
              </div>
            </div>
            <!-- Margin Impact Callout -->
            <div class="mt-4 p-4 rounded-lg border border-success/30 bg-success/5"
                 x-show="yearEndData.yoy_comparison?.margin_impact_dollars > 0">
              <div class="flex items-start gap-3">
                <div class="text-success text-lg leading-none mt-0.5">&#9650;</div>
                <div>
                  <div class="text-sm font-semibold text-success">
                    Margin improvement added
                    <span x-text="fmtCurrency(yearEndData.yoy_comparison?.margin_impact_dollars)"></span>
                    to the bottom line
                  </div>
                  <div class="text-xs text-[#64748b] mt-1">
                    At <span x-text="yearEndData.yoy_comparison?.prev_year"></span>'s
                    <span x-text="(yearEndData.yoy_comparison?.margin_prev ?? 0).toFixed(1) + '%'"></span> margin,
                    <span x-text="yearEndData.year"></span> revenue would have produced
                    <span x-text="fmtCurrency(yearEndData.yoy_comparison?.profit_at_old_margin)"></span> in profit
                    instead of <span x-text="fmtCurrency(yearEndData.kpis?.total_profit)"></span>.
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Monthly Summary Table -->
          <div class="chart-container mb-6 overflow-x-auto">
            <h3 class="text-sm font-semibold text-[#f8fafc] mb-4">Monthly Summary</h3>
            <table class="data-table sticky-col">
              <thead>
                <tr>
                  <th>Month</th>
                  <th class="text-right">Revenue</th>
                  <th class="text-right">Profit</th>
                  <th class="text-right">Margin</th>
                  <th class="text-right">Units</th>
                  <th class="text-right">FP %</th>
                </tr>
              </thead>
              <tbody>
                <template x-for="(row, idx) in (yearEndData.monthly_summary || [])" :key="idx">
                  <tr>
                    <td class="font-medium" x-text="row.month || row.label"></td>
                    <td class="text-right" x-text="fmtCurrency(row.revenue)"></td>
                    <td class="text-right" x-text="fmtCurrency(row.profit)"></td>
                    <td class="text-right">
                      <span :class="(row.margin ?? 0) >= 55 ? 'text-success font-semibold' :
                                     (row.margin ?? 0) >= 50 ? 'text-[#cbd5e1] font-semibold' : 'text-destructive font-semibold'"
                            x-text="fmtPct(row.margin)"></span>
                    </td>
                    <td class="text-right" x-text="fmtN(row.units)"></td>
                    <td class="text-right" x-text="fmtPct(row.full_price_pct)"></td>
                  </tr>
                </template>
                <!-- Total Row -->
                <tr class="total-row" x-show="yearEndData.totals">
                  <td class="font-bold">TOTAL</td>
                  <td class="text-right font-bold" x-text="fmtCurrency(yearEndData.totals?.revenue)"></td>
                  <td class="text-right font-bold" x-text="fmtCurrency(yearEndData.totals?.profit)"></td>
                  <td class="text-right font-bold" x-text="fmtPct(yearEndData.totals?.margin)"></td>
                  <td class="text-right font-bold" x-text="fmtN(yearEndData.totals?.units)"></td>
                  <td class="text-right font-bold" x-text="fmtPct(yearEndData.totals?.full_price_pct)"></td>
                </tr>
              </tbody>
            </table>
          </div>

          <!-- Footer -->
          <div class="text-center text-xs text-[#64748b] py-6 border-t border-muted">
            Generated on <span x-text="new Date().toLocaleDateString()"></span> &mdash; Thrive Cannabis &mdash; Confidential
          </div>
        </div>
      </template>

      <!-- Empty state -->
      <div x-show="!yearEndData && !loading" x-cloak class="text-center py-20 text-[#475569]">
        <svg class="mx-auto mb-4" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" opacity="0.3">
          <rect x="3" y="4" width="18" height="18" rx="2"/>
          <line x1="16" y1="2" x2="16" y2="6"/>
          <line x1="8" y1="2" x2="8" y2="6"/>
          <line x1="3" y1="10" x2="21" y2="10"/>
        </svg>
        <div class="text-sm">Loading year-end summary...</div>
      </div>
    </section>

    <!-- ========================================================== -->
    <!-- BRAND REPORTS PAGE                                          -->
    <!-- ========================================================== -->
    <section x-show="view === 'brands'" x-cloak>

      <!-- Brand search + sub-tabs + download -->
      <div class="flex flex-col sm:flex-row sm:items-center gap-3 mb-6">
        <!-- Selected brand label -->
        <div class="text-sm text-[#94a3b8] font-medium flex items-center gap-2" x-show="selectedBrand" x-cloak>
          Viewing: <span class="text-primary font-semibold" x-text="selectedBrand"></span>
          <img x-show="selectedBrand && internalBrands.has(selectedBrand.toUpperCase())" src="/logo.png" class="w-4 h-4" style="filter: brightness(0) saturate(100%) invert(62%) sepia(30%) saturate(500%) hue-rotate(350deg) brightness(95%)" title="Thrive In-House Brand">
        </div>

        <div class="sm:ml-auto flex items-center gap-2 flex-wrap">
          <!-- Sub-tabs (44px min tap targets) -->
          <div class="flex rounded-lg border border-muted overflow-hidden">
            <button class="px-4 py-2.5 md:py-1.5 text-sm md:text-xs font-medium transition-colors"
                    :class="brandSubTab === 'dispensary' ? 'bg-gold text-[#0f1117]' : 'bg-[#161922] text-[#94a3b8] hover:bg-[#1e293b]'"
                    @click="brandSubTab = 'dispensary'">Dispensary Report</button>
            <button class="px-4 py-2.5 md:py-1.5 text-sm md:text-xs font-medium transition-colors"
                    :class="brandSubTab === 'facing' ? 'bg-gold text-[#0f1117]' : 'bg-[#161922] text-[#94a3b8] hover:bg-[#1e293b]'"
                    @click="brandSubTab = 'facing'; if(selectedBrand && !facingReport) loadFacingReport();">Brand Facing</button>
          </div>

          <!-- Download Excel -->
          <a x-show="brandSubTab === 'dispensary' && selectedBrand" x-cloak
             :href="'/api/brands/' + encodeURIComponent(selectedBrand) + '/excel' + periodQuery()"
             class="px-3 py-2.5 md:py-1.5 text-sm md:text-xs font-medium bg-success text-white rounded-lg hover:bg-success/90 transition-colors flex items-center gap-1">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
            Excel
          </a>
          <a x-show="brandSubTab === 'facing' && selectedBrand" x-cloak
             :href="'/api/brands/' + encodeURIComponent(selectedBrand) + '/facing/excel' + periodQuery()"
             class="px-3 py-2.5 md:py-1.5 text-sm md:text-xs font-medium bg-success text-white rounded-lg hover:bg-success/90 transition-colors flex items-center gap-1">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
            Excel
          </a>
        </div>
      </div>

      <!-- ====== DISPENSARY SUB-TAB ====== -->
      <div x-show="brandSubTab === 'dispensary'" x-cloak>
        <template x-if="brandReport">
          <div>
            <!-- KPI Cards: Row 1 — Sales Performance -->
            <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4 mb-4">
              <div class="kpi-card">
                <div class="text-[11px] font-semibold uppercase tracking-wider text-[#64748b] mb-1">Revenue</div>
                <div class="text-2xl font-bold text-[#f8fafc] font-mono" x-text="fmtCurrency(brandReport.kpis?.revenue)"></div>
              </div>
              <div class="kpi-card">
                <div class="text-[11px] font-semibold uppercase tracking-wider text-[#64748b] mb-1">Margin</div>
                <div class="text-2xl font-bold" x-text="fmtPct(brandReport.kpis?.margin)"
                     :class="(brandReport.kpis?.margin ?? 0) >= 55 ? 'text-success' :
                             (brandReport.kpis?.margin ?? 0) >= 50 ? 'text-[#cbd5e1]' : 'text-destructive'"></div>
              </div>
              <div class="kpi-card">
                <div class="text-[11px] font-semibold uppercase tracking-wider text-[#64748b] mb-1">Category Rank</div>
                <div class="text-2xl font-bold text-[#f8fafc] font-mono">
                  #<span x-text="brandReport.kpis?.category_rank"></span>/<span x-text="brandReport.kpis?.category_total"></span>
                </div>
                <div class="text-xs text-[#64748b]" x-text="brandReport.kpis?.primary_category"></div>
              </div>
              <div class="kpi-card">
                <div class="text-[11px] font-semibold uppercase tracking-wider text-[#64748b] mb-1">Units</div>
                <div class="text-2xl font-bold text-[#f8fafc] font-mono" x-text="fmtN(brandReport.kpis?.units)"></div>
              </div>
              <div class="kpi-card">
                <div class="text-[11px] font-semibold uppercase tracking-wider text-[#64748b] mb-1">Customers</div>
                <div class="text-2xl font-bold text-[#f8fafc] font-mono" x-text="fmtN(brandReport.kpis?.customers)"></div>
              </div>
              <div class="kpi-card">
                <div class="text-[11px] font-semibold uppercase tracking-wider text-[#64748b] mb-1">vs Category</div>
                <div class="text-2xl font-bold"
                     :class="(brandReport.kpis?.vs_category_margin_pts ?? 0) >= 0 ? 'text-success' : 'text-destructive'"
                     x-text="(brandReport.kpis?.vs_category_margin_pts >= 0 ? '+' : '') + (brandReport.kpis?.vs_category_margin_pts?.toFixed(1) || '0') + ' pts'"></div>
              </div>
            </div>

            <!-- KPI Cards: Row 2 — Cost & Spend -->
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
              <div class="kpi-card border-l-4 border-l-gold">
                <div class="text-[11px] font-semibold uppercase tracking-wider text-[#64748b] mb-1">Total Cost (Our Spend)</div>
                <div class="text-2xl font-bold text-[#f8fafc] font-mono" x-text="fmtCurrency(brandReport.kpis?.total_cost)"></div>
              </div>
              <div class="kpi-card border-l-4 border-l-gold">
                <div class="text-[11px] font-semibold uppercase tracking-wider text-[#64748b] mb-1">Net Profit</div>
                <div class="text-2xl font-bold"
                     :class="(brandReport.kpis?.total_profit ?? 0) >= 0 ? 'text-success' : 'text-destructive'"
                     x-text="fmtCurrency(brandReport.kpis?.total_profit)"></div>
              </div>
              <div class="kpi-card border-l-4 border-l-gold">
                <div class="text-[11px] font-semibold uppercase tracking-wider text-[#64748b] mb-1">Avg Monthly Spend</div>
                <div class="text-2xl font-bold text-[#f8fafc] font-mono" x-text="fmtCurrency(brandReport.kpis?.avg_monthly_cost)"></div>
                <div class="text-xs text-[#64748b]" x-text="(brandReport.kpis?.months_count || 0) + ' months'"></div>
              </div>
              <div class="kpi-card border-l-4 border-l-gold">
                <div class="text-[11px] font-semibold uppercase tracking-wider text-[#64748b] mb-1">Blended Cost/Unit</div>
                <div class="text-2xl font-bold text-[#f8fafc] font-mono" x-text="'$' + (brandReport.kpis?.cost_per_unit?.toFixed(2) || '0.00')"></div>
              </div>
            </div>

            <!-- Cost & Margin by Category -->
            <div class="chart-container mb-6"
                 x-show="brandReport.category_breakdown?.filter(c => c.units > 0).length > 1" x-cloak>
              <h3 class="text-sm font-semibold text-[#f8fafc] mb-4">Cost & Margin by Product Type</h3>
              <div class="grid gap-3"
                   :class="brandReport.category_breakdown?.filter(c => c.units > 0).length <= 4 ? 'grid-cols-1 sm:grid-cols-2 md:grid-cols-' + brandReport.category_breakdown?.filter(c => c.units > 0).length : 'grid-cols-1 sm:grid-cols-2 md:grid-cols-4'">
                <template x-for="cat in (brandReport.category_breakdown || []).filter(c => c.units > 0).sort((a,b) => b.revenue - a.revenue)" :key="cat.category_clean">
                  <div class="bg-[#0f1117] rounded-lg p-4 border border-[rgba(255,255,255,0.06)]">
                    <div class="text-[10px] font-semibold uppercase tracking-wider text-gold mb-3" x-text="cat.category_clean"></div>
                    <div class="grid grid-cols-3 gap-2">
                      <div>
                        <div class="text-[10px] uppercase text-[#64748b]">Cost/Unit</div>
                        <div class="text-sm font-bold text-[#f8fafc] font-mono" x-text="'$' + (cat.units > 0 ? (cat.cost / cat.units).toFixed(2) : '0.00')"></div>
                      </div>
                      <div>
                        <div class="text-[10px] uppercase text-[#64748b]">Margin</div>
                        <div class="text-sm font-bold font-mono"
                             :class="(cat.margin ?? 0) >= 55 ? 'text-success' : (cat.margin ?? 0) >= 50 ? 'text-[#94a3b8]' : 'text-destructive'"
                             x-text="fmtPct(cat.margin)"></div>
                      </div>
                      <div>
                        <div class="text-[10px] uppercase text-[#64748b]">Units</div>
                        <div class="text-sm font-bold text-[#f8fafc] font-mono" x-text="fmtN(cat.units)"></div>
                      </div>
                    </div>
                  </div>
                </template>
              </div>
            </div>

            <!-- Monthly Revenue Trend Chart -->
            <div class="mb-6 chart-container">
              <h3 class="text-sm font-semibold text-[#f8fafc] mb-4">Monthly Revenue Trend</h3>
              <div class="relative" style="height:300px">
                <canvas id="chart-brand-trend"></canvas>
              </div>
            </div>

            <!-- Monthly Cost & Revenue Table -->
            <div class="chart-container mb-6 overflow-x-auto" x-show="brandReport.trend && brandReport.trend.length > 0" x-cloak>
              <h3 class="text-sm font-semibold text-[#f8fafc] mb-4">Monthly Cost & Revenue Breakdown</h3>
              <table class="data-table sticky-col">
                <thead>
                  <tr>
                    <th>Month</th>
                    <th class="text-right">Revenue</th>
                    <th class="text-right">Cost</th>
                    <th class="text-right">Profit</th>
                    <th class="text-right">Margin</th>
                    <th class="text-right">Units</th>
                    <th class="text-right">Txns</th>
                  </tr>
                </thead>
                <tbody>
                  <template x-for="(t, idx) in (brandReport.trend || [])" :key="idx">
                    <tr>
                      <td class="font-medium" x-text="t.period"></td>
                      <td class="text-right" x-text="fmtCurrency(t.revenue)"></td>
                      <td class="text-right" x-text="fmtCurrency(t.cost)"></td>
                      <td class="text-right" x-text="fmtCurrency(t.profit)"></td>
                      <td class="text-right">
                        <span :class="(t.margin ?? 0) >= 55 ? 'text-success font-semibold' :
                                       (t.margin ?? 0) >= 50 ? 'text-[#cbd5e1] font-semibold' : 'text-destructive font-semibold'"
                              x-text="fmtPct(t.margin)"></span>
                      </td>
                      <td class="text-right" x-text="fmtN(t.units)"></td>
                      <td class="text-right" x-text="fmtN(t.transactions)"></td>
                    </tr>
                  </template>
                </tbody>
              </table>
            </div>

            <!-- Revenue by Category + Share of Category side by side -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
              <div class="chart-container">
                <h3 class="text-sm font-semibold text-[#f8fafc] mb-4">Revenue by Category</h3>
                <div class="relative" style="height:280px">
                  <canvas id="chart-brand-categories"></canvas>
                </div>
              </div>
              <div class="chart-container">
                <h3 class="text-sm font-semibold text-[#f8fafc] mb-4">Share of Category</h3>
                <div class="relative" style="height:280px">
                  <canvas id="chart-brand-soc"></canvas>
                </div>
              </div>
            </div>

            <!-- Discount Depth Chart -->
            <div class="mb-6 chart-container">
              <h3 class="text-sm font-semibold text-[#f8fafc] mb-4">Discount Depth</h3>
              <div class="relative" style="height:280px">
                <canvas id="chart-brand-depth"></canvas>
              </div>
            </div>

            <!-- Velocity by Category Table -->
            <div class="chart-container mb-6 overflow-x-auto" x-show="brandReport.velocity_by_category && brandReport.velocity_by_category.length > 0" x-cloak>
              <h3 class="text-sm font-semibold text-[#f8fafc] mb-4">Velocity by Category</h3>
              <table class="data-table sticky-col">
                <thead>
                  <tr>
                    <th>Category</th>
                    <th class="text-right">Brand Units/Day</th>
                    <th class="text-right">Cat Avg/Day</th>
                    <th class="text-right">Velocity Index</th>
                    <th class="text-right">Brand $/Unit</th>
                    <th class="text-right">Cat $/Unit</th>
                    <th class="text-right">Brands</th>
                  </tr>
                </thead>
                <tbody>
                  <template x-for="(v, idx) in (brandReport.velocity_by_category || [])" :key="idx">
                    <tr>
                      <td class="font-medium" x-text="v.category"></td>
                      <td class="text-right" x-text="v.brand_units_day?.toFixed(1)"></td>
                      <td class="text-right" x-text="v.cat_avg_day?.toFixed(1)"></td>
                      <td class="text-right">
                        <span class="font-semibold"
                              :class="(v.velocity_index ?? 0) > 120 ? 'text-success' :
                                      (v.velocity_index ?? 0) < 80 ? 'text-destructive' : 'text-primary'"
                              x-text="v.velocity_index?.toFixed(0)"></span>
                      </td>
                      <td class="text-right" x-text="fmtCurrency(v.brand_per_unit)"></td>
                      <td class="text-right" x-text="fmtCurrency(v.cat_per_unit)"></td>
                      <td class="text-right" x-text="v.brands_in_cat"></td>
                    </tr>
                  </template>
                </tbody>
              </table>
            </div>

            <!-- Top Products Table -->
            <div class="chart-container mb-6 overflow-x-auto" x-show="brandReport.top_products && brandReport.top_products.length > 0" x-cloak>
              <h3 class="text-sm font-semibold text-[#f8fafc] mb-4">Top Products</h3>
              <table class="data-table sticky-col">
                <thead>
                  <tr>
                    <th>Product</th>
                    <th class="text-right">Revenue</th>
                    <th class="text-right">Cost</th>
                    <th class="text-right">Cost/Unit</th>
                    <th class="text-right">Units</th>
                    <th class="text-right">Margin</th>
                    <th class="text-right">Profit</th>
                    <th class="text-right">Txns</th>
                  </tr>
                </thead>
                <tbody>
                  <template x-for="(p, idx) in (brandReport.top_products || [])" :key="idx">
                    <tr>
                      <td class="font-medium max-w-[250px] truncate" x-text="p.product"></td>
                      <td class="text-right" x-text="fmtCurrency(p.revenue)"></td>
                      <td class="text-right" x-text="fmtCurrency(p.cost)"></td>
                      <td class="text-right" x-text="'$' + (p.units ? (p.cost / p.units).toFixed(2) : '0.00')"></td>
                      <td class="text-right" x-text="fmtN(p.units)"></td>
                      <td class="text-right">
                        <span :class="(p.margin ?? 0) >= 55 ? 'text-success font-semibold' :
                                       (p.margin ?? 0) >= 50 ? 'text-[#cbd5e1] font-semibold' : 'text-destructive font-semibold'"
                              x-text="fmtPct(p.margin)"></span>
                      </td>
                      <td class="text-right" x-text="fmtCurrency(p.profit)"></td>
                      <td class="text-right" x-text="fmtN(p.transactions)"></td>
                    </tr>
                  </template>
                </tbody>
              </table>
            </div>

            <!-- Deal Performance Table -->
            <div class="chart-container mb-6 overflow-x-auto" x-show="brandReport.deal_performance && brandReport.deal_performance.length > 0" x-cloak>
              <h3 class="text-sm font-semibold text-[#f8fafc] mb-4">Deal Performance</h3>
              <table class="data-table sticky-col">
                <thead>
                  <tr>
                    <th>Deal Name</th>
                    <th class="text-right">Uses</th>
                    <th class="text-right">Revenue</th>
                    <th class="text-right">Discounts</th>
                    <th class="text-right">Margin</th>
                    <th class="text-right">Profit</th>
                  </tr>
                </thead>
                <tbody>
                  <template x-for="(d, idx) in (brandReport.deal_performance || [])" :key="idx">
                    <tr>
                      <td class="font-medium max-w-[200px] truncate" x-text="d.deal_name"></td>
                      <td class="text-right" x-text="fmtN(d.uses)"></td>
                      <td class="text-right" x-text="fmtCurrency(d.revenue)"></td>
                      <td class="text-right text-destructive" x-text="fmtCurrency(d.discounts)"></td>
                      <td class="text-right">
                        <span :class="(d.margin ?? 0) >= 55 ? 'text-success font-semibold' :
                                       (d.margin ?? 0) >= 50 ? 'text-[#cbd5e1] font-semibold' : 'text-destructive font-semibold'"
                              x-text="fmtPct(d.margin)"></span>
                      </td>
                      <td class="text-right" x-text="fmtCurrency(d.profit)"></td>
                    </tr>
                  </template>
                </tbody>
              </table>
            </div>

            <!-- Performance by Store Table -->
            <div class="chart-container mb-6 overflow-x-auto" x-show="brandReport.by_store && brandReport.by_store.length > 0" x-cloak>
              <h3 class="text-sm font-semibold text-[#f8fafc] mb-4">Performance by Store</h3>
              <table class="data-table sticky-col">
                <thead>
                  <tr>
                    <th>Store</th>
                    <th class="text-right">Revenue</th>
                    <th class="text-right">Cost</th>
                    <th class="text-right">Units</th>
                    <th class="text-right">Margin</th>
                    <th class="text-right">Disc Rate</th>
                    <th class="text-right">Profit</th>
                  </tr>
                </thead>
                <tbody>
                  <template x-for="(s, idx) in (brandReport.by_store || [])" :key="idx">
                    <tr>
                      <td class="font-medium" x-text="s.store"></td>
                      <td class="text-right" x-text="fmtCurrency(s.revenue)"></td>
                      <td class="text-right" x-text="fmtCurrency(s.cost)"></td>
                      <td class="text-right" x-text="fmtN(s.units)"></td>
                      <td class="text-right">
                        <span :class="(s.margin ?? 0) >= 55 ? 'text-success font-semibold' :
                                       (s.margin ?? 0) >= 50 ? 'text-[#cbd5e1] font-semibold' : 'text-destructive font-semibold'"
                              x-text="fmtPct(s.margin)"></span>
                      </td>
                      <td class="text-right text-destructive" x-text="fmtPct(s.disc_rate)"></td>
                      <td class="text-right" x-text="fmtCurrency(s.profit)"></td>
                    </tr>
                  </template>
                </tbody>
              </table>
            </div>

            <!-- Recommendations -->
            <div class="mb-6" x-show="brandReport.recommendations && brandReport.recommendations.length > 0" x-cloak>
              <h3 class="text-sm font-semibold text-[#f8fafc] mb-3">Recommendations</h3>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                <template x-for="(rec, idx) in (brandReport.recommendations || [])" :key="idx">
                  <div class="p-4 rounded-lg text-sm border"
                       :class="rec.severity === 'high' ? 'bg-[rgba(239,68,68,0.1)] border-[rgba(239,68,68,0.2)] text-[#fca5a5]' :
                               rec.severity === 'medium' ? 'bg-[rgba(245,158,11,0.1)] border-[rgba(245,158,11,0.2)] text-[#fcd34d]' : 'bg-[rgba(34,197,94,0.1)] border-[rgba(34,197,94,0.2)] text-[#86efac]'"
                    <div class="font-semibold mb-1 text-[#f8fafc]" x-text="rec.title"></div>
                    <div class="text-[#94a3b8]" x-text="rec.message || rec.detail"></div>
                  </div>
                </template>
              </div>
            </div>
          </div>
        </template>

        <!-- Empty state - dispensary -->
        <div x-show="!brandReport && !loading" x-cloak class="text-center py-20 text-[#475569]">
          <svg class="mx-auto mb-4" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" opacity="0.3">
            <path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83 0L2 12V2h10l8.59 8.59a2 2 0 010 2.82z"/>
            <line x1="7" y1="7" x2="7.01" y2="7"/>
          </svg>
          <div class="text-sm" x-text="selectedBrand ? 'Loading brand report...' : 'Search for a brand to view its report'"></div>
        </div>
      </div>

      <!-- ====== FACING SUB-TAB ====== -->
      <div x-show="brandSubTab === 'facing'" x-cloak>
        <template x-if="facingReport">
          <div>
            <!-- 6 KPI Cards -->
            <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4 mb-6">
              <div class="kpi-card">
                <div class="text-[11px] font-semibold uppercase tracking-wider text-[#64748b] mb-1">Revenue</div>
                <div class="text-2xl font-bold text-[#f8fafc] font-mono" x-text="fmtCurrency(facingReport.kpis?.revenue)"></div>
              </div>
              <div class="kpi-card">
                <div class="text-[11px] font-semibold uppercase tracking-wider text-[#64748b] mb-1">Margin</div>
                <div class="text-2xl font-bold" x-text="fmtPct(facingReport.kpis?.margin)"
                     :class="(facingReport.kpis?.margin ?? 0) >= 55 ? 'text-success' :
                             (facingReport.kpis?.margin ?? 0) >= 50 ? 'text-[#cbd5e1]' : 'text-destructive'"></div>
              </div>
              <div class="kpi-card">
                <div class="text-[11px] font-semibold uppercase tracking-wider text-[#64748b] mb-1">Store Coverage</div>
                <div class="text-2xl font-bold text-[#f8fafc] font-mono" x-text="facingReport.kpis?.store_coverage || '-'"></div>
              </div>
              <div class="kpi-card">
                <div class="text-[11px] font-semibold uppercase tracking-wider text-[#64748b] mb-1">Velocity Rank</div>
                <div class="text-2xl font-bold text-[#f8fafc] font-mono" x-text="facingReport.kpis?.velocity_rank || '-'"></div>
              </div>
              <div class="kpi-card">
                <div class="text-[11px] font-semibold uppercase tracking-wider text-[#64748b] mb-1">Units</div>
                <div class="text-2xl font-bold text-[#f8fafc] font-mono" x-text="fmtN(facingReport.kpis?.units)"></div>
              </div>
              <div class="kpi-card">
                <div class="text-[11px] font-semibold uppercase tracking-wider text-[#64748b] mb-1">Full Price %</div>
                <div class="text-2xl font-bold text-[#f8fafc] font-mono" x-text="fmtPct(facingReport.kpis?.full_price_pct)"></div>
              </div>
            </div>

            <!-- Distribution Scorecard Table -->
            <div class="chart-container mb-6 overflow-x-auto" x-show="facingReport.distribution_scorecard && facingReport.distribution_scorecard.length > 0" x-cloak>
              <h3 class="text-sm font-semibold text-[#f8fafc] mb-4">Distribution Scorecard</h3>
              <table class="data-table sticky-col">
                <thead>
                  <tr>
                    <th>Store</th>
                    <th class="text-center">Carried</th>
                    <th class="text-right">SKUs</th>
                    <th class="text-right">Brand Revenue</th>
                    <th class="text-right">Units</th>
                    <th class="text-right">Brand Share</th>
                  </tr>
                </thead>
                <tbody>
                  <template x-for="(s, idx) in (facingReport.distribution_scorecard || [])" :key="idx">
                    <tr>
                      <td class="font-medium" x-text="s.store"></td>
                      <td class="text-center">
                        <span :class="s.carried ? 'text-success' : 'text-destructive'" x-text="s.carried ? '\u2713' : '\u2717'"></span>
                      </td>
                      <td class="text-right" x-text="s.skus"></td>
                      <td class="text-right" x-text="fmtCurrency(s.brand_revenue)"></td>
                      <td class="text-right" x-text="fmtN(s.units)"></td>
                      <td class="text-right" x-text="fmtPct(s.brand_share)"></td>
                    </tr>
                  </template>
                </tbody>
              </table>
            </div>

            <!-- Share of Category + Velocity Benchmarking side by side -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
              <div class="chart-container">
                <h3 class="text-sm font-semibold text-[#f8fafc] mb-4">Share of Category</h3>
                <div class="relative" style="height:280px">
                  <canvas id="chart-facing-soc"></canvas>
                </div>
              </div>
              <div class="chart-container">
                <h3 class="text-sm font-semibold text-[#f8fafc] mb-4">Velocity Benchmarking</h3>
                <div class="relative" style="height:280px">
                  <canvas id="chart-facing-velocity"></canvas>
                </div>
              </div>
            </div>

            <!-- Store Gap Analysis Table -->
            <div class="chart-container mb-6 overflow-x-auto" x-show="facingReport.store_gap_analysis && facingReport.store_gap_analysis.length > 0" x-cloak>
              <h3 class="text-sm font-semibold text-[#f8fafc] mb-4">Store Gap Analysis</h3>
              <table class="data-table sticky-col">
                <thead>
                  <tr>
                    <th>Store</th>
                    <th>Category</th>
                    <th class="text-right">Category Revenue</th>
                    <th class="text-right">Opportunity</th>
                  </tr>
                </thead>
                <tbody>
                  <template x-for="(g, idx) in (facingReport.store_gap_analysis || [])" :key="idx">
                    <tr>
                      <td class="font-medium" x-text="g.store"></td>
                      <td x-text="g.category"></td>
                      <td class="text-right" x-text="fmtCurrency(g.category_revenue)"></td>
                      <td class="text-right text-success font-semibold" x-text="fmtCurrency(g.opportunity)"></td>
                    </tr>
                  </template>
                </tbody>
              </table>
            </div>

            <!-- Top Products (Facing) -->
            <div class="chart-container mb-6 overflow-x-auto" x-show="facingReport.top_products && facingReport.top_products.length > 0" x-cloak>
              <h3 class="text-sm font-semibold text-[#f8fafc] mb-4">Top Products</h3>
              <table class="data-table sticky-col">
                <thead>
                  <tr>
                    <th>Product</th>
                    <th class="text-right">Stores</th>
                    <th class="text-right">Revenue</th>
                    <th class="text-right">Units</th>
                    <th class="text-right">Margin</th>
                  </tr>
                </thead>
                <tbody>
                  <template x-for="(p, idx) in (facingReport.top_products || [])" :key="idx">
                    <tr>
                      <td class="font-medium max-w-[250px] truncate" x-text="p.product"></td>
                      <td class="text-right" x-text="p.stores"></td>
                      <td class="text-right" x-text="fmtCurrency(p.revenue)"></td>
                      <td class="text-right" x-text="fmtN(p.units)"></td>
                      <td class="text-right">
                        <span :class="(p.margin ?? 0) >= 55 ? 'text-success font-semibold' :
                                       (p.margin ?? 0) >= 50 ? 'text-[#cbd5e1] font-semibold' : 'text-destructive font-semibold'"
                              x-text="fmtPct(p.margin)"></span>
                      </td>
                    </tr>
                  </template>
                </tbody>
              </table>
            </div>

            <!-- SKU Expansion Table -->
            <div class="chart-container mb-6 overflow-x-auto" x-show="facingReport.sku_expansion && facingReport.sku_expansion.length > 0" x-cloak>
              <h3 class="text-sm font-semibold text-[#f8fafc] mb-4">SKU Expansion Opportunities</h3>
              <table class="data-table sticky-col">
                <thead>
                  <tr>
                    <th>Product</th>
                    <th class="text-right">Current Stores</th>
                    <th class="text-right">Total Stores</th>
                    <th class="text-right">Revenue</th>
                    <th>Missing From</th>
                  </tr>
                </thead>
                <tbody>
                  <template x-for="(s, idx) in (facingReport.sku_expansion || [])" :key="idx">
                    <tr>
                      <td class="font-medium max-w-[200px] truncate" x-text="s.product"></td>
                      <td class="text-right" x-text="s.current_stores"></td>
                      <td class="text-right" x-text="s.total_stores"></td>
                      <td class="text-right" x-text="fmtCurrency(s.revenue)"></td>
                      <td class="text-xs max-w-[200px] truncate" x-text="(s.missing_from || []).join(', ')"></td>
                    </tr>
                  </template>
                </tbody>
              </table>
            </div>

            <!-- Pricing Consistency Table -->
            <div class="chart-container mb-6 overflow-x-auto" x-show="facingReport.pricing_consistency && facingReport.pricing_consistency.length > 0" x-cloak>
              <h3 class="text-sm font-semibold text-[#f8fafc] mb-4">Pricing Consistency</h3>
              <table class="data-table sticky-col">
                <thead>
                  <tr>
                    <th>Product</th>
                    <th class="text-right">Stores</th>
                    <th class="text-right">Min</th>
                    <th class="text-right">Max</th>
                    <th class="text-right">Avg</th>
                    <th class="text-right">Range %</th>
                  </tr>
                </thead>
                <tbody>
                  <template x-for="(p, idx) in (facingReport.pricing_consistency || [])" :key="idx">
                    <tr :class="(p.range_pct ?? 0) > 20 ? 'bg-[rgba(245,158,11,0.08)]' : ''">
                      <td class="font-medium max-w-[200px] truncate" x-text="p.product"></td>
                      <td class="text-right" x-text="p.stores"></td>
                      <td class="text-right" x-text="fmtCurrency(p.min)"></td>
                      <td class="text-right" x-text="fmtCurrency(p.max)"></td>
                      <td class="text-right" x-text="fmtCurrency(p.avg)"></td>
                      <td class="text-right" :class="(p.range_pct ?? 0) > 20 ? 'text-destructive font-semibold' : ''"
                          x-text="fmtPct(p.range_pct)"></td>
                    </tr>
                  </template>
                </tbody>
              </table>
            </div>

            <!-- Promotional Effectiveness -->
            <div class="mb-6" x-show="facingReport.promotional_effectiveness" x-cloak>
              <h3 class="text-sm font-semibold text-[#f8fafc] mb-3">Promotional Effectiveness</h3>
              <!-- Lift KPIs -->
              <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4" x-show="facingReport.promotional_effectiveness?.lift_kpis">
                <div class="kpi-card">
                  <div class="text-[11px] font-semibold uppercase tracking-wider text-[#64748b] mb-1">Revenue Lift</div>
                  <div class="text-xl font-bold text-[#f8fafc] font-mono" x-text="fmtPct(facingReport.promotional_effectiveness?.lift_kpis?.revenue_lift)"></div>
                </div>
                <div class="kpi-card">
                  <div class="text-[11px] font-semibold uppercase tracking-wider text-[#64748b] mb-1">Unit Lift</div>
                  <div class="text-xl font-bold text-[#f8fafc] font-mono" x-text="fmtPct(facingReport.promotional_effectiveness?.lift_kpis?.unit_lift)"></div>
                </div>
                <div class="kpi-card">
                  <div class="text-[11px] font-semibold uppercase tracking-wider text-[#64748b] mb-1">Promo Margin</div>
                  <div class="text-xl font-bold text-[#f8fafc] font-mono" x-text="fmtPct(facingReport.promotional_effectiveness?.lift_kpis?.promo_margin)"></div>
                </div>
                <div class="kpi-card">
                  <div class="text-[11px] font-semibold uppercase tracking-wider text-[#64748b] mb-1">Promo Share</div>
                  <div class="text-xl font-bold text-[#f8fafc] font-mono" x-text="fmtPct(facingReport.promotional_effectiveness?.lift_kpis?.promo_share)"></div>
                </div>
              </div>
              <!-- By Deal Table -->
              <div class="chart-container overflow-x-auto" x-show="facingReport.promotional_effectiveness?.by_deal && facingReport.promotional_effectiveness.by_deal.length > 0">
                <table class="data-table sticky-col">
                  <thead>
                    <tr>
                      <th>Deal</th>
                      <th class="text-right">Uses</th>
                      <th class="text-right">Revenue</th>
                      <th class="text-right">Discounts</th>
                      <th class="text-right">Margin</th>
                    </tr>
                  </thead>
                  <tbody>
                    <template x-for="(d, idx) in (facingReport.promotional_effectiveness?.by_deal || [])" :key="idx">
                      <tr>
                        <td class="font-medium max-w-[250px] truncate" x-text="d.deal_name || d.deal"></td>
                        <td class="text-right" x-text="fmtN(d.uses)"></td>
                        <td class="text-right" x-text="fmtCurrency(d.revenue)"></td>
                        <td class="text-right text-destructive" x-text="fmtCurrency(d.discounts)"></td>
                        <td class="text-right">
                          <span :class="(d.margin ?? 0) >= 55 ? 'text-success font-semibold' :
                                         (d.margin ?? 0) >= 50 ? 'font-semibold text-[#94a3b8]' : 'text-destructive font-semibold'"
                                x-text="fmtPct(d.margin)"></span>
                        </td>
                      </tr>
                    </template>
                  </tbody>
                </table>
              </div>
            </div>

            <!-- Growth Opportunities -->
            <div class="mb-6" x-show="facingReport.growth_opportunities && facingReport.growth_opportunities.length > 0" x-cloak>
              <h3 class="text-sm font-semibold text-[#f8fafc] mb-3">Growth Opportunities</h3>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                <template x-for="(opp, idx) in (facingReport.growth_opportunities || [])" :key="idx">
                  <div class="p-4 bg-[#161922] rounded-lg border border-[#1e293b]">
                    <div class="font-semibold text-sm text-[#f8fafc] mb-1" x-text="opp.title"></div>
                    <div class="text-xs text-[#94a3b8]" x-text="opp.description || opp.detail"></div>
                    <div class="text-xs text-success font-semibold mt-2" x-show="opp.potential" x-text="'Potential: ' + fmtCurrency(opp.potential)"></div>
                  </div>
                </template>
              </div>
            </div>
          </div>
        </template>

        <!-- Empty state - facing -->
        <div x-show="!facingReport && !loading" x-cloak class="text-center py-20 text-[#475569]">
          <svg class="mx-auto mb-4" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" opacity="0.3">
            <path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83 0L2 12V2h10l8.59 8.59a2 2 0 010 2.82z"/>
            <line x1="7" y1="7" x2="7.01" y2="7"/>
          </svg>
          <div class="text-sm" x-text="selectedBrand ? 'Loading brand facing report...' : 'Search for a brand to view its facing report'"></div>
        </div>
      </div>
    </section>

    <!-- ========================================================== -->
    <!-- MASTER REPORTS PAGE                                         -->
    <!-- ========================================================== -->
    <section x-show="view === 'master'" x-cloak>

      <!-- Sub-tabs + Download -->
      <div class="flex flex-col sm:flex-row sm:items-center gap-3 mb-6">
        <div class="flex rounded-lg border border-muted overflow-x-auto -mx-3 px-3 sm:mx-0 sm:px-0">
          <template x-for="tab in ['margin','deals','budtenders','customers','rewards']" :key="tab">
            <button class="px-4 py-2.5 md:py-1.5 text-sm md:text-xs font-medium capitalize transition-colors whitespace-nowrap"
                    :class="masterTab === tab ? 'bg-gold text-[#0f1117]' : 'bg-[#161922] text-[#94a3b8] hover:bg-[#1e293b]'"
                    @click="masterTab = tab; loadMasterReport()"
                    x-text="tab"></button>
          </template>
        </div>
        <div class="sm:ml-auto flex items-center gap-2">
          <a :href="'/api/master/' + masterTab + '/excel' + periodQuery()"
             class="px-3 py-2.5 md:py-1.5 text-sm md:text-xs font-medium bg-success text-white rounded-lg hover:bg-success/90 transition-colors flex items-center gap-1">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
            Download
          </a>
          <a :href="'/api/master/suite/excel' + periodQuery()"
             class="px-3 py-2.5 md:py-1.5 text-sm md:text-xs font-medium bg-gold text-[#0f1117] rounded-lg hover:bg-gold/90 transition-colors flex items-center gap-1">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
            Suite ZIP
          </a>
        </div>
      </div>

      <!-- ====== MARGIN TAB ====== -->
      <div x-show="masterTab === 'margin'" x-cloak>
        <template x-if="masterData && masterTab === 'margin'">
          <div>
            <!-- 5 KPIs -->
            <div class="grid grid-cols-2 md:grid-cols-5 gap-4 mb-6">
              <div class="kpi-card">
                <div class="text-[11px] font-semibold uppercase tracking-wider text-[#64748b] mb-1">Revenue</div>
                <div class="text-2xl font-bold text-[#f8fafc] font-mono" x-text="fmtCurrency(masterData.kpis?.revenue)"></div>
              </div>
              <div class="kpi-card">
                <div class="text-[11px] font-semibold uppercase tracking-wider text-[#64748b] mb-1">Net Profit</div>
                <div class="text-2xl font-bold text-[#f8fafc] font-mono" x-text="fmtCurrency(masterData.kpis?.net_profit)"></div>
              </div>
              <div class="kpi-card">
                <div class="text-[11px] font-semibold uppercase tracking-wider text-[#64748b] mb-1">Blended Margin</div>
                <div class="text-2xl font-bold text-[#f8fafc] font-mono" x-text="fmtPct(masterData.kpis?.blended_margin)"></div>
              </div>
              <div class="kpi-card">
                <div class="text-[11px] font-semibold uppercase tracking-wider text-[#64748b] mb-1">FP Margin</div>
                <div class="text-2xl font-bold text-success" x-text="fmtPct(masterData.kpis?.fp_margin)"></div>
              </div>
              <div class="kpi-card">
                <div class="text-[11px] font-semibold uppercase tracking-wider text-[#64748b] mb-1">Disc Margin</div>
                <div class="text-2xl font-bold text-destructive" x-text="fmtPct(masterData.kpis?.disc_margin)"></div>
              </div>
            </div>

            <!-- By Store Table -->
            <div class="chart-container mb-6 overflow-x-auto" x-show="masterData.by_store && masterData.by_store.length > 0" x-cloak>
              <h3 class="text-sm font-semibold text-[#f8fafc] mb-4">Margin by Store</h3>
              <table class="data-table sticky-col">
                <thead>
                  <tr>
                    <th>Store</th>
                    <th class="text-right">Revenue</th>
                    <th class="text-right">Units</th>
                    <th class="text-right">FP %</th>
                    <th class="text-right">FP Margin</th>
                    <th class="text-right">Disc Margin</th>
                    <th class="text-right">Blended</th>
                    <th class="text-right">Profit</th>
                  </tr>
                </thead>
                <tbody>
                  <template x-for="(s, idx) in (masterData.by_store || [])" :key="idx">
                    <tr>
                      <td class="font-medium" x-text="s.store"></td>
                      <td class="text-right" x-text="fmtCurrency(s.revenue)"></td>
                      <td class="text-right" x-text="fmtN(s.units)"></td>
                      <td class="text-right" x-text="fmtPct(s.fp_pct)"></td>
                      <td class="text-right text-success" x-text="fmtPct(s.fp_margin)"></td>
                      <td class="text-right text-destructive" x-text="fmtPct(s.disc_margin)"></td>
                      <td class="text-right">
                        <span :class="(s.blended ?? 0) >= 55 ? 'text-success font-semibold' :
                                       (s.blended ?? 0) >= 50 ? 'text-[#cbd5e1] font-semibold' : 'text-destructive font-semibold'"
                              x-text="fmtPct(s.blended)"></span>
                      </td>
                      <td class="text-right" x-text="fmtCurrency(s.profit)"></td>
                    </tr>
                  </template>
                </tbody>
              </table>
            </div>

            <!-- By Category Table -->
            <div class="chart-container mb-6 overflow-x-auto" x-show="masterData.by_category && masterData.by_category.length > 0" x-cloak>
              <h3 class="text-sm font-semibold text-[#f8fafc] mb-4">Margin by Category</h3>
              <table class="data-table sticky-col">
                <thead>
                  <tr>
                    <th>Category</th>
                    <th class="text-right">Revenue</th>
                    <th class="text-right">Units</th>
                    <th class="text-right">FP %</th>
                    <th class="text-right">FP Margin</th>
                    <th class="text-right">Disc Margin</th>
                    <th class="text-right">Blended</th>
                    <th class="text-right">Profit</th>
                  </tr>
                </thead>
                <tbody>
                  <template x-for="(c, idx) in (masterData.by_category || [])" :key="idx">
                    <tr>
                      <td class="font-medium" x-text="c.category"></td>
                      <td class="text-right" x-text="fmtCurrency(c.revenue)"></td>
                      <td class="text-right" x-text="fmtN(c.units)"></td>
                      <td class="text-right" x-text="fmtPct(c.fp_pct)"></td>
                      <td class="text-right text-success" x-text="fmtPct(c.fp_margin)"></td>
                      <td class="text-right text-destructive" x-text="fmtPct(c.disc_margin)"></td>
                      <td class="text-right">
                        <span :class="(c.blended ?? 0) >= 55 ? 'text-success font-semibold' :
                                       (c.blended ?? 0) >= 50 ? 'text-[#cbd5e1] font-semibold' : 'text-destructive font-semibold'"
                              x-text="fmtPct(c.blended)"></span>
                      </td>
                      <td class="text-right" x-text="fmtCurrency(c.profit)"></td>
                    </tr>
                  </template>
                </tbody>
              </table>
            </div>

            <!-- Top 30 Brands Table -->
            <div class="chart-container mb-6 overflow-x-auto" x-show="masterData.top_brands && masterData.top_brands.length > 0" x-cloak>
              <h3 class="text-sm font-semibold text-[#f8fafc] mb-4">Top 30 Brands</h3>
              <table class="data-table sticky-col">
                <thead>
                  <tr>
                    <th>Brand</th>
                    <th class="text-right">Revenue</th>
                    <th class="text-right">Units</th>
                    <th class="text-right">FP %</th>
                    <th class="text-right">FP Margin</th>
                    <th class="text-right">Disc Margin</th>
                    <th class="text-right">Blended</th>
                    <th class="text-right">Profit</th>
                  </tr>
                </thead>
                <tbody>
                  <template x-for="(b, idx) in (masterData.top_brands || [])" :key="idx">
                    <tr>
                      <td class="font-medium">
                        <div class="flex items-center gap-1.5">
                          <a href="#" class="text-[#f8fafc] hover:text-gold hover:underline"
                             @click.prevent="selectedBrand = b.brand; brandSearch = b.brand; switchView('brands'); loadBrandReport();"
                             x-text="b.brand"></a>
                          <img x-show="internalBrands.has((b.brand||'').toUpperCase())" src="/logo.png" class="w-4 h-4" style="filter: brightness(0) saturate(100%) invert(62%) sepia(30%) saturate(500%) hue-rotate(350deg) brightness(95%)" title="Thrive In-House Brand">
                        </div>
                      </td>
                      <td class="text-right" x-text="fmtCurrency(b.revenue)"></td>
                      <td class="text-right" x-text="fmtN(b.units)"></td>
                      <td class="text-right" x-text="fmtPct(b.fp_pct)"></td>
                      <td class="text-right text-success" x-text="fmtPct(b.fp_margin)"></td>
                      <td class="text-right text-destructive" x-text="fmtPct(b.disc_margin)"></td>
                      <td class="text-right">
                        <span :class="(b.blended ?? 0) >= 55 ? 'text-success font-semibold' :
                                       (b.blended ?? 0) >= 50 ? 'text-[#cbd5e1] font-semibold' : 'text-destructive font-semibold'"
                              x-text="fmtPct(b.blended)"></span>
                      </td>
                      <td class="text-right" x-text="fmtCurrency(b.profit)"></td>
                    </tr>
                  </template>
                </tbody>
              </table>
            </div>
          </div>
        </template>
      </div>

      <!-- ====== DEALS TAB ====== -->
      <div x-show="masterTab === 'deals'" x-cloak>
        <template x-if="masterData && masterTab === 'deals'">
          <div>
            <!-- Deal Types Table -->
            <div class="chart-container mb-6 overflow-x-auto" x-show="masterData.deal_types && masterData.deal_types.length > 0" x-cloak>
              <h3 class="text-sm font-semibold text-[#f8fafc] mb-4">Deal Types</h3>
              <table class="data-table sticky-col">
                <thead>
                  <tr>
                    <th>Deal Type</th>
                    <th class="text-right">Txns</th>
                    <th class="text-right">Units</th>
                    <th class="text-right">Revenue</th>
                    <th class="text-right">Discounts</th>
                    <th class="text-right">Disc Rate</th>
                    <th class="text-right">Margin</th>
                    <th class="text-right">Profit</th>
                  </tr>
                </thead>
                <tbody>
                  <template x-for="(d, idx) in (masterData.deal_types || [])" :key="idx">
                    <tr>
                      <td class="font-medium" x-text="d.deal_type"></td>
                      <td class="text-right" x-text="fmtN(d.transactions)"></td>
                      <td class="text-right" x-text="fmtN(d.units)"></td>
                      <td class="text-right" x-text="fmtCurrency(d.revenue)"></td>
                      <td class="text-right text-destructive" x-text="fmtCurrency(d.discounts)"></td>
                      <td class="text-right text-destructive" x-text="fmtPct(d.disc_rate)"></td>
                      <td class="text-right">
                        <span :class="(d.margin ?? 0) >= 55 ? 'text-success font-semibold' :
                                       (d.margin ?? 0) >= 50 ? 'text-[#cbd5e1] font-semibold' : 'text-destructive font-semibold'"
                              x-text="fmtPct(d.margin)"></span>
                      </td>
                      <td class="text-right" x-text="fmtCurrency(d.profit)"></td>
                    </tr>
                  </template>
                </tbody>
              </table>
            </div>

            <!-- Top 50 Deals Table -->
            <div class="chart-container mb-6 overflow-x-auto" x-show="masterData.top_deals && masterData.top_deals.length > 0" x-cloak>
              <h3 class="text-sm font-semibold text-[#f8fafc] mb-4">Top 50 Deals</h3>
              <table class="data-table sticky-col">
                <thead>
                  <tr>
                    <th>Deal Name</th>
                    <th class="text-right">Times Used</th>
                    <th class="text-right">Revenue</th>
                    <th class="text-right">Discounts</th>
                    <th class="text-right">Margin</th>
                  </tr>
                </thead>
                <tbody>
                  <template x-for="(d, idx) in (masterData.top_deals || [])" :key="idx">
                    <tr>
                      <td class="font-medium max-w-[250px] truncate" x-text="d.deal_name"></td>
                      <td class="text-right" x-text="fmtN(d.times_used)"></td>
                      <td class="text-right" x-text="fmtCurrency(d.revenue)"></td>
                      <td class="text-right text-destructive" x-text="fmtCurrency(d.discounts)"></td>
                      <td class="text-right">
                        <span :class="(d.margin ?? 0) >= 55 ? 'text-success font-semibold' :
                                       (d.margin ?? 0) >= 50 ? 'text-[#cbd5e1] font-semibold' : 'text-destructive font-semibold'"
                              x-text="fmtPct(d.margin)"></span>
                      </td>
                    </tr>
                  </template>
                </tbody>
              </table>
            </div>
          </div>
        </template>
      </div>

      <!-- ====== BUDTENDERS TAB ====== -->
      <div x-show="masterTab === 'budtenders'" x-cloak>
        <template x-if="masterData && masterTab === 'budtenders'">
          <div>
            <!-- 4 KPIs -->
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
              <div class="kpi-card">
                <div class="text-[11px] font-semibold uppercase tracking-wider text-[#64748b] mb-1">Total Budtenders</div>
                <div class="text-2xl font-bold text-[#f8fafc] font-mono" x-text="fmtN(masterData.kpis?.total_budtenders)"></div>
              </div>
              <div class="kpi-card">
                <div class="text-[11px] font-semibold uppercase tracking-wider text-[#64748b] mb-1">Avg Sales Score</div>
                <div class="text-2xl font-bold text-[#f8fafc] font-mono" x-text="masterData.kpis?.avg_sales_score?.toFixed(1) || '-'"></div>
              </div>
              <div class="kpi-card">
                <div class="text-[11px] font-semibold uppercase tracking-wider text-[#64748b] mb-1">Top Performers</div>
                <div class="text-2xl font-bold text-success" x-text="fmtN(masterData.kpis?.top_performers)"></div>
              </div>
              <div class="kpi-card">
                <div class="text-[11px] font-semibold uppercase tracking-wider text-[#64748b] mb-1">Needs Coaching</div>
                <div class="text-2xl font-bold text-destructive" x-text="fmtN(masterData.kpis?.needs_coaching)"></div>
              </div>
            </div>

            <!-- Rankings Table -->
            <div class="chart-container mb-6 overflow-x-auto" x-show="masterData.rankings && masterData.rankings.length > 0" x-cloak>
              <h3 class="text-sm font-semibold text-[#f8fafc] mb-4">Budtender Rankings</h3>
              <table class="data-table sticky-col">
                <thead>
                  <tr>
                    <th>Budtender</th>
                    <th>Store</th>
                    <th class="text-right">Score</th>
                    <th class="text-center">Tier</th>
                    <th class="text-right">Txns</th>
                    <th class="text-right">Sales</th>
                    <th class="text-right">Avg Cart</th>
                    <th class="text-right">Units/Cart</th>
                    <th class="text-right">Disc %</th>
                  </tr>
                </thead>
                <tbody>
                  <template x-for="(b, idx) in (masterData.rankings || [])" :key="idx">
                    <tr>
                      <td class="font-medium" x-text="b.budtender"></td>
                      <td class="text-xs" x-text="b.store"></td>
                      <td class="text-right">
                        <span class="font-semibold"
                              :class="(b.score ?? 0) >= 80 ? 'text-success' :
                                      (b.score ?? 0) >= 60 ? 'text-primary' : 'text-destructive'"
                              x-text="b.score?.toFixed(1)"></span>
                      </td>
                      <td class="text-center">
                        <span class="px-2 py-0.5 text-[10px] font-semibold rounded-full"
                              :class="b.tier === 'Elite' ? 'bg-[rgba(34,197,94,0.1)] text-success' :
                                      b.tier === 'Strong' ? 'bg-gold/10 text-gold' :
                                      b.tier === 'Average' ? 'bg-[rgba(255,255,255,0.05)] text-[#94a3b8]' : 'bg-[rgba(239,68,68,0.1)] text-destructive'"
                              x-text="b.tier"></span>
                      </td>
                      <td class="text-right" x-text="fmtN(b.transactions)"></td>
                      <td class="text-right" x-text="fmtCurrency(b.sales)"></td>
                      <td class="text-right" x-text="fmtCurrency(b.avg_cart)"></td>
                      <td class="text-right" x-text="b.units_per_cart?.toFixed(1)"></td>
                      <td class="text-right text-destructive" x-text="fmtPct(b.disc_pct)"></td>
                    </tr>
                  </template>
                </tbody>
              </table>
            </div>
          </div>
        </template>
      </div>

      <!-- ====== CUSTOMERS TAB ====== -->
      <div x-show="masterTab === 'customers'" x-cloak>
        <template x-if="masterData && masterTab === 'customers'">
          <div>
            <!-- KPIs -->
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
              <div class="kpi-card">
                <div class="text-[11px] font-semibold uppercase tracking-wider text-[#64748b] mb-1">Total Customers</div>
                <div class="text-2xl font-bold text-[#f8fafc] font-mono" x-text="fmtN(masterData.kpis?.total_customers)"></div>
              </div>
              <div class="kpi-card">
                <div class="text-[11px] font-semibold uppercase tracking-wider text-[#64748b] mb-1">Avg Spend</div>
                <div class="text-2xl font-bold text-[#f8fafc] font-mono" x-text="fmtCurrency(masterData.kpis?.avg_spend)"></div>
              </div>
              <div class="kpi-card">
                <div class="text-[11px] font-semibold uppercase tracking-wider text-[#64748b] mb-1">Total Revenue</div>
                <div class="text-2xl font-bold text-[#f8fafc] font-mono" x-text="fmtCurrency(masterData.kpis?.total_revenue)"></div>
              </div>
              <div class="kpi-card">
                <div class="text-[11px] font-semibold uppercase tracking-wider text-destructive-400 mb-1">Discount Rate</div>
                <div class="text-2xl font-bold text-destructive" x-text="fmtPct(masterData.kpis?.discount_rate)"></div>
              </div>
            </div>

            <!-- Segments Table -->
            <div class="chart-container mb-6 overflow-x-auto" x-show="masterData.segments && masterData.segments.length > 0" x-cloak>
              <h3 class="text-sm font-semibold text-[#f8fafc] mb-4">Customer Segments</h3>
              <table class="data-table sticky-col">
                <thead>
                  <tr>
                    <th>Segment</th>
                    <th class="text-right">Customers</th>
                    <th class="text-right">% of Cust</th>
                    <th class="text-right">Revenue</th>
                    <th class="text-right">% of Rev</th>
                    <th class="text-right">Rev/Cust</th>
                    <th class="text-right">Disc Rate</th>
                  </tr>
                </thead>
                <tbody>
                  <template x-for="(seg, idx) in (masterData.segments || [])" :key="idx">
                    <tr>
                      <td class="font-medium" x-text="seg.segment"></td>
                      <td class="text-right" x-text="fmtN(seg.customers)"></td>
                      <td class="text-right" x-text="fmtPct(seg.pct_of_customers)"></td>
                      <td class="text-right" x-text="fmtCurrency(seg.revenue)"></td>
                      <td class="text-right" x-text="fmtPct(seg.pct_of_revenue)"></td>
                      <td class="text-right" x-text="fmtCurrency(seg.revenue_per_customer)"></td>
                      <td class="text-right text-destructive" x-text="fmtPct(seg.disc_rate)"></td>
                    </tr>
                  </template>
                </tbody>
              </table>
            </div>

            <!-- Top 50 Customers Table -->
            <div class="chart-container mb-6 overflow-x-auto" x-show="masterData.top_customers && masterData.top_customers.length > 0" x-cloak>
              <h3 class="text-sm font-semibold text-[#f8fafc] mb-4">Top 50 Customers</h3>
              <table class="data-table sticky-col">
                <thead>
                  <tr>
                    <th class="text-center">#</th>
                    <th>Customer</th>
                    <th>Store</th>
                    <th class="text-center">Segment</th>
                    <th class="text-right">Spend</th>
                    <th class="text-right">Txns</th>
                    <th class="text-right">Avg Txn</th>
                    <th class="text-right">Disc Rate</th>
                  </tr>
                </thead>
                <tbody>
                  <template x-for="(c, idx) in (masterData.top_customers || [])" :key="idx">
                    <tr>
                      <td class="text-center text-[#475569]" x-text="idx + 1"></td>
                      <td class="font-medium" x-text="c.customer"></td>
                      <td class="text-xs" x-text="c.store"></td>
                      <td class="text-center">
                        <span class="px-2 py-0.5 text-[10px] font-semibold rounded-full"
                              :class="c.segment === 'VIP' ? 'bg-gold/10 text-gold' :
                                      c.segment === 'Regular' ? 'bg-[rgba(34,197,94,0.1)] text-success' :
                                      c.segment === 'Occasional' ? 'bg-[rgba(255,255,255,0.05)] text-[#94a3b8]' : 'bg-[rgba(239,68,68,0.1)] text-destructive'"
                              x-text="c.segment"></span>
                      </td>
                      <td class="text-right" x-text="fmtCurrency(c.spend)"></td>
                      <td class="text-right" x-text="fmtN(c.transactions)"></td>
                      <td class="text-right" x-text="fmtCurrency(c.avg_transaction)"></td>
                      <td class="text-right text-destructive" x-text="fmtPct(c.disc_rate)"></td>
                    </tr>
                  </template>
                </tbody>
              </table>
            </div>
          </div>
        </template>
      </div>

      <!-- ====== REWARDS TAB ====== -->
      <div x-show="masterTab === 'rewards'" x-cloak>
        <template x-if="masterData && masterTab === 'rewards'">
          <div>
            <!-- 4+4 KPIs -->
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
              <div class="kpi-card">
                <div class="text-[11px] font-semibold uppercase tracking-wider text-[#64748b] mb-1">Total Redemptions</div>
                <div class="text-2xl font-bold text-[#f8fafc] font-mono" x-text="fmtN(masterData.kpis?.total_redemptions)"></div>
              </div>
              <div class="kpi-card">
                <div class="text-[11px] font-semibold uppercase tracking-wider text-[#64748b] mb-1">Net Cost</div>
                <div class="text-2xl font-bold text-destructive" x-text="fmtCurrency(masterData.kpis?.net_cost)"></div>
              </div>
              <div class="kpi-card">
                <div class="text-[11px] font-semibold uppercase tracking-wider text-[#64748b] mb-1">Unique Rewards</div>
                <div class="text-2xl font-bold text-[#f8fafc] font-mono" x-text="fmtN(masterData.kpis?.unique_rewards)"></div>
              </div>
              <div class="kpi-card">
                <div class="text-[11px] font-semibold uppercase tracking-wider text-[#64748b] mb-1">Markout Employees</div>
                <div class="text-2xl font-bold text-[#f8fafc] font-mono" x-text="fmtN(masterData.kpis?.markout_employees)"></div>
              </div>
            </div>

            <!-- All Rewards Table -->
            <div class="chart-container mb-6 overflow-x-auto" x-show="masterData.all_rewards && masterData.all_rewards.length > 0" x-cloak>
              <h3 class="text-sm font-semibold text-[#f8fafc] mb-4">All Rewards</h3>
              <table class="data-table sticky-col">
                <thead>
                  <tr>
                    <th>Reward</th>
                    <th class="text-right">Redemptions</th>
                    <th class="text-right">Units</th>
                    <th class="text-right">Retail Value</th>
                    <th class="text-right">Cost</th>
                    <th class="text-right">Net Cost</th>
                    <th class="text-right">% of Total</th>
                  </tr>
                </thead>
                <tbody>
                  <template x-for="(r, idx) in (masterData.all_rewards || [])" :key="idx">
                    <tr>
                      <td class="font-medium max-w-[250px] truncate" x-text="r.reward"></td>
                      <td class="text-right" x-text="fmtN(r.redemptions)"></td>
                      <td class="text-right" x-text="fmtN(r.units)"></td>
                      <td class="text-right" x-text="fmtCurrency(r.retail_value)"></td>
                      <td class="text-right text-destructive" x-text="fmtCurrency(r.cost)"></td>
                      <td class="text-right text-destructive" x-text="fmtCurrency(r.net_cost)"></td>
                      <td class="text-right" x-text="fmtPct(r.pct_of_total)"></td>
                    </tr>
                  </template>
                </tbody>
              </table>
            </div>

            <!-- Markouts by Employee Table -->
            <div class="chart-container mb-6 overflow-x-auto" x-show="masterData.markouts_by_employee && masterData.markouts_by_employee.length > 0" x-cloak>
              <h3 class="text-sm font-semibold text-[#f8fafc] mb-4">Markouts by Employee</h3>
              <table class="data-table sticky-col">
                <thead>
                  <tr>
                    <th class="text-center">#</th>
                    <th>Employee</th>
                    <th>Store</th>
                    <th class="text-right">Redemptions</th>
                    <th class="text-right">Units</th>
                    <th class="text-right">Cost</th>
                    <th>Products</th>
                  </tr>
                </thead>
                <tbody>
                  <template x-for="(e, idx) in (masterData.markouts_by_employee || [])" :key="idx">
                    <tr>
                      <td class="text-center text-[#475569]" x-text="idx + 1"></td>
                      <td class="font-medium" x-text="e.employee"></td>
                      <td class="text-xs" x-text="e.store"></td>
                      <td class="text-right" x-text="fmtN(e.redemptions)"></td>
                      <td class="text-right" x-text="fmtN(e.units)"></td>
                      <td class="text-right text-destructive" x-text="fmtCurrency(e.cost)"></td>
                      <td class="text-xs max-w-[200px] truncate" x-text="e.products"></td>
                    </tr>
                  </template>
                </tbody>
              </table>
            </div>
          </div>
        </template>
      </div>

      <!-- Empty state - master -->
      <div x-show="!masterData && !loading" x-cloak class="text-center py-20 text-[#475569]">
        <svg class="mx-auto mb-4" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" opacity="0.3">
          <path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/>
          <polyline points="14 2 14 8 20 8"/>
          <line x1="16" y1="13" x2="8" y2="13"/>
          <line x1="16" y1="17" x2="8" y2="17"/>
        </svg>
        <div class="text-sm">Loading master report...</div>
      </div>
    </section>

    <!-- ========================================================== -->
    <!-- DATA MANAGER PAGE                                           -->
    <!-- ========================================================== -->
    <section x-show="view === 'datamanager'" x-cloak>

      <!-- Upload + Status panels side by side -->
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">

        <!-- Upload Panel -->
        <div class="chart-container">
          <h3 class="text-sm font-semibold text-[#f8fafc] mb-4">Upload CSV Files</h3>
          <!-- Drag & Drop Area -->
          <div class="border-2 border-dashed border-[#1e293b] rounded-lg p-8 text-center transition-colors hover:border-gold"
               @dragover.prevent="$el.classList.add('border-gold','bg-gold/5')"
               @dragleave.prevent="$el.classList.remove('border-gold','bg-gold/5')"
               @drop.prevent="$el.classList.remove('border-gold','bg-gold/5'); handleFileDrop($event)">
            <svg class="mx-auto mb-3" width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="#c8956c" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
              <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/>
              <polyline points="17 8 12 3 7 8"/>
              <line x1="12" y1="3" x2="12" y2="15"/>
            </svg>
            <div class="text-sm text-[#94a3b8] mb-2">Drag & drop CSV files here</div>
            <div class="text-xs text-[#64748b] mb-3">or</div>
            <label class="inline-block px-4 py-2 text-sm font-medium bg-gold text-white rounded-lg cursor-pointer hover:bg-gold/90 transition-colors">
              Browse Files
              <input type="file" accept=".csv" multiple class="hidden" @change="handleFileSelect($event)">
            </label>
          </div>
          <!-- Upload Progress -->
          <div class="mt-4" x-show="uploadProgress !== null" x-cloak>
            <div class="flex justify-between text-xs text-[#94a3b8] mb-1">
              <span>Uploading...</span>
              <span x-text="uploadProgress + '%'"></span>
            </div>
            <div class="h-2 bg-muted rounded-full overflow-hidden">
              <div class="h-full bg-gold rounded-full transition-all" :style="'width:' + (uploadProgress || 0) + '%'"></div>
            </div>
          </div>
          <div class="mt-3 text-sm text-success font-medium" x-show="uploadSuccess" x-cloak x-text="uploadSuccess"></div>
          <div class="mt-3 text-sm text-destructive font-medium" x-show="uploadError" x-cloak x-text="uploadError"></div>
        </div>

        <!-- Status Panel -->
        <div class="chart-container">
          <div class="flex items-center justify-between mb-4">
            <h3 class="text-sm font-semibold text-primary">Data Status</h3>
            <button @click="reloadData()"
                    class="px-3 py-1.5 text-xs font-medium bg-gold text-[#0f1117] rounded-lg hover:bg-gold/90 transition-colors flex items-center gap-1">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <polyline points="23 4 23 10 17 10"/>
                <path d="M20.49 15a9 9 0 11-2.12-9.36L23 10"/>
              </svg>
              Reload
            </button>
          </div>
          <div class="space-y-3" x-show="health">
            <div class="flex justify-between items-center py-2 border-b border-muted">
              <span class="text-sm text-[#94a3b8]">Total Rows</span>
              <span class="text-sm font-semibold text-primary" x-text="health ? fmtN(health.rows) : '-'"></span>
            </div>
            <div class="flex justify-between items-center py-2 border-b border-muted">
              <span class="text-sm text-[#94a3b8]">Regular Rows</span>
              <span class="text-sm font-semibold text-primary" x-text="health ? fmtN(health.regular_rows) : '-'"></span>
            </div>
            <div class="flex justify-between items-center py-2 border-b border-muted">
              <span class="text-sm text-[#94a3b8]">Stores</span>
              <span class="text-sm font-semibold text-primary" x-text="health?.stores || '-'"></span>
            </div>
            <div class="flex justify-between items-center py-2 border-b border-muted">
              <span class="text-sm text-[#94a3b8]">Brands</span>
              <span class="text-sm font-semibold text-primary" x-text="health?.brands || '-'"></span>
            </div>
            <div class="flex justify-between items-center py-2">
              <span class="text-sm text-[#94a3b8]">Periods</span>
              <span class="text-sm font-semibold text-primary" x-text="health?.periods || '-'"></span>
            </div>
          </div>
        </div>
      </div>

      <!-- File List Table -->
      <div class="chart-container mb-6 overflow-x-auto" x-show="dataFiles && dataFiles.length > 0" x-cloak>
        <h3 class="text-sm font-semibold text-[#f8fafc] mb-4">Loaded Files</h3>
        <table class="data-table sticky-col">
          <thead>
            <tr>
              <th>File</th>
              <th>Path</th>
              <th class="text-right">Size</th>
              <th>Modified</th>
              <th class="text-center">Actions</th>
            </tr>
          </thead>
          <tbody>
            <template x-for="(f, idx) in (dataFiles || [])" :key="idx">
              <tr>
                <td class="font-medium" x-text="f.name"></td>
                <td class="text-xs text-[#64748b] max-w-[250px] truncate" x-text="f.path"></td>
                <td class="text-right text-xs" x-text="formatSize(f.size)"></td>
                <td class="text-xs" x-text="new Date(f.modified).toLocaleDateString()"></td>
                <td class="text-center">
                  <button @click="if(confirm('Delete ' + f.name + '?')) deleteFile(f.path)"
                          class="px-2 py-1 text-xs text-destructive hover:bg-destructive/10 rounded transition-colors">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <polyline points="3 6 5 6 21 6"/>
                      <path d="M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/>
                    </svg>
                  </button>
                </td>
              </tr>
            </template>
          </tbody>
        </table>
      </div>

      <!-- Empty state - data manager -->
      <div x-show="!health && !loading" x-cloak class="text-center py-20 text-[#475569]">
        <svg class="mx-auto mb-4" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" opacity="0.3">
          <ellipse cx="12" cy="5" rx="9" ry="3"/>
          <path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"/>
          <path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"/>
        </svg>
        <div class="text-sm">Loading data manager...</div>
      </div>
    </section>

  </div>
</main>

<script>
const COLORS = ['#c8956c', '#22c55e', '#64748b', '#a8555a', '#c49357', '#8b5cf6', '#06b6d4', '#ec4899', '#84cc16', '#14b8a6'];
// Verify Chart.js loaded
if (typeof Chart === 'undefined') {
  console.error('FATAL: Chart.js did not load');
  document.addEventListener('DOMContentLoaded', () => {
    document.querySelectorAll('.chart-container').forEach(c => {
      const d = c.querySelector('[style*="height"]');
      if (d) d.innerHTML = '<div style="padding:40px;text-align:center;color:#a8555a;font-size:13px">Chart.js library failed to load. Check network.</div>';
    });
  });
} else {
  // Dark theme defaults for Chart.js
  Chart.defaults.color = '#94a3b8';
  Chart.defaults.borderColor = 'rgba(255,255,255,0.06)';
  Chart.defaults.plugins.legend.labels.color = '#94a3b8';
  Chart.defaults.scales = Chart.defaults.scales || {};
  ['linear','category'].forEach(t => {
    if (!Chart.defaults.scales[t]) Chart.defaults.scales[t] = {};
    Chart.defaults.scales[t].grid = { color: 'rgba(255,255,255,0.06)' };
    Chart.defaults.scales[t].ticks = { ...(Chart.defaults.scales[t].ticks||{}), color: '#94a3b8' };
  });
  console.log('Chart.js v' + Chart.version + ' loaded');
}
const MO = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
const MONTHS = ['January','February','March','April','May','June','July','August','September','October','November','December'];

function dashboard() {
  return {
    view: 'executive',
    sidebarOpen: false,
    masterTab: 'margin',
    brandSubTab: 'dispensary',
    loading: false,
    error: null,
    brands: [],
    internalBrands: new Set(),
    stores: [],
    health: null,
    periods: [],
    showPicker: false,
    pickStart: null,
    pickEnd: null,
    periodType: 'month',
    periodLabel: '',
    startYear: null,
    startMonth: null,
    endYear: null,
    endMonth: null,
    yearEndYear: 2025,
    selectedStore: '',
    selectedBrand: '',
    brandSearch: '',
    showBrandDD: false,
    execData: null,
    momData: null,
    storeData: null,
    yearEndData: null,
    brandReport: null,
    facingReport: null,
    masterData: null,
    dmFiles: null,
    dmReloading: false,
    uploadStatus: null,
    uploadProgress: null,
    uploadSuccess: null,
    uploadError: null,
    dataFiles: [],
    _charts: {},

    filteredBrands() {
      if (!this.brandSearch) return this.brands.slice(0, 30);
      const q = this.brandSearch.toLowerCase();
      return this.brands.filter(b => b.toLowerCase().includes(q)).slice(0, 30);
    },

    pageTitle() {
      return {executive:'Executive Summary', mom:'Month-over-Month', stores:'Store Performance', yearend:'Year-End Summary', brands:'Brand Reports', master:'Master Reports', datamanager:'Data Manager'}[this.view] || '';
    },

    get periodsByYear() {
      const map = {};
      for (const p of this.periods) {
        if (!map[p.year]) map[p.year] = new Set();
        map[p.year].add(p.month);
      }
      return Object.keys(map).sort((a,b) => b-a).map(y => ({year: parseInt(y), months: map[y]}));
    },

    async init() {
      // Each call catches independently so one failure doesn't break all
      const [h, b, s, p] = await Promise.all([
        this.api('/api/health').catch(() => null),
        this.api('/api/brands').catch(() => ({brands:[]})),
        this.api('/api/stores').catch(() => ({stores:[]})),
        this.api('/api/periods').catch(() => ({periods:[]})),
      ]);
      if (h) this.health = h;
      this.brands = b.brands || b || [];
      this.internalBrands = new Set((b.internal_brands || []).map(x => x.toUpperCase()));
      this.stores = s.stores || s || [];
      this.periods = p.periods || p || [];
      // Default to most recent month
      if (this.periods.length) {
        const latest = this.periods[this.periods.length - 1];
        this.startYear = latest.year;
        this.startMonth = latest.month;
        this.periodType = 'month';
        this.periodLabel = MONTHS[latest.month - 1] + ' ' + latest.year;
      } else {
        this.periodType = 'all';
        this.periodLabel = 'All Time';
      }
      this.loadCurrentView();
    },

    async api(path, params = {}) {
      const url = new URL(path, location.origin);
      for (const [k, v] of Object.entries(params)) {
        if (v !== null && v !== undefined && v !== '') url.searchParams.set(k, v);
      }
      const r = await fetch(url);
      if (!r.ok) throw new Error(await r.text().catch(() => r.statusText));
      return r.json();
    },

    periodParams() {
      const p = {};
      if (this.periodType === 'all') {
        p.period_type = 'all';
      } else if (this.periodType === 'month') {
        p.period_type = 'month';
        p.year = this.startYear;
        p.month = this.startMonth;
      } else if (this.periodType === 'range') {
        p.period_type = 'range';
        p.start_year = this.startYear;
        p.start_month = this.startMonth;
        p.end_year = this.endYear;
        p.end_month = this.endMonth;
      }
      if (this.selectedStore) p.store = this.selectedStore;
      return p;
    },

    openPicker() {
      if (this.periodType === 'all') { this.pickStart = null; this.pickEnd = null; }
      else if (this.periodType === 'month') { this.pickStart = {year:this.startYear,month:this.startMonth}; this.pickEnd = null; }
      else { this.pickStart = {year:this.startYear,month:this.startMonth}; this.pickEnd = {year:this.endYear,month:this.endMonth}; }
      this.showPicker = true;
    },

    clickMonth(y, m) {
      if (!this.hasData(y, m)) return;
      if (!this.pickStart || (this.pickStart && this.pickEnd)) {
        this.pickStart = {year:y, month:m};
        this.pickEnd = null;
      } else {
        this.pickEnd = {year:y, month:m};
        const s = this.pickStart.year*100+this.pickStart.month, e = y*100+m;
        if (e < s) [this.pickStart, this.pickEnd] = [this.pickEnd, this.pickStart];
      }
    },

    hasData(y, m) {
      return this.periods.some(p => p.year === y && p.month === m);
    },

    isSelected(y, m) {
      const ym = y*100+m;
      return (this.pickStart && this.pickStart.year*100+this.pickStart.month === ym) ||
             (this.pickEnd && this.pickEnd.year*100+this.pickEnd.month === ym);
    },

    isInRange(y, m) {
      if (!this.pickStart) return false;
      const ym = y*100+m, s = this.pickStart.year*100+this.pickStart.month;
      if (!this.pickEnd) return ym === s;
      const e = this.pickEnd.year*100+this.pickEnd.month;
      return ym >= s && ym <= e;
    },

    selectPreset(type) {
      const now = new Date();
      const cy = now.getFullYear(), cm = now.getMonth()+1;
      const years = [...new Set(this.periods.map(p=>p.year))].sort();
      const ly = years.length ? years[years.length-1] : cy;
      const presets = {
        all: [null, null],
        ytd: [{year:cy,month:1}, {year:cy,month:cm}],
        h1: [{year:ly,month:1}, {year:ly,month:6}],
        h2: [{year:ly,month:7}, {year:ly,month:12}],
        q1: [{year:ly,month:1}, {year:ly,month:3}],
        q2: [{year:ly,month:4}, {year:ly,month:6}],
        q3: [{year:ly,month:7}, {year:ly,month:9}],
        q4: [{year:ly,month:10}, {year:ly,month:12}],
      };
      const [s, e] = presets[type] || [null, null];
      this.pickStart = s;
      this.pickEnd = e;
      this.applyPeriod();
    },

    applyPeriod() {
      this.showPicker = false;
      if (!this.pickStart) {
        this.periodType = 'all';
        this.periodLabel = 'All Time';
        this.startYear = null; this.startMonth = null; this.endYear = null; this.endMonth = null;
      } else if (!this.pickEnd || (this.pickStart.year===this.pickEnd.year && this.pickStart.month===this.pickEnd.month)) {
        this.periodType = 'month';
        this.startYear = this.pickStart.year; this.startMonth = this.pickStart.month;
        this.endYear = null; this.endMonth = null;
        this.periodLabel = MONTHS[this.startMonth-1] + ' ' + this.startYear;
      } else {
        this.periodType = 'range';
        this.startYear = this.pickStart.year; this.startMonth = this.pickStart.month;
        this.endYear = this.pickEnd.year; this.endMonth = this.pickEnd.month;
        this.periodLabel = MO[this.startMonth-1]+' '+this.startYear+' - '+MO[this.endMonth-1]+' '+this.endYear;
      }
      this.loadCurrentView();
    },

    clearPeriod() {
      this.pickStart = null;
      this.pickEnd = null;
    },

    switchView(v) {
      this.view = v;
      this.error = null;
      this.sidebarOpen = false;
      this.loadCurrentView();
    },

    loadCurrentView() {
      if (this.view === 'executive') this.loadExecSummary();
      else if (this.view === 'mom') this.loadMoM();
      else if (this.view === 'stores') this.loadStorePerf();
      else if (this.view === 'yearend') this.loadYearEnd();
      else if (this.view === 'brands') { if (this.brandSubTab==='dispensary' && this.selectedBrand) this.loadBrandReport(); else if (this.brandSubTab==='facing' && this.selectedBrand) this.loadFacingReport(); }
      else if (this.view === 'master') this.loadMasterReport();
      else if (this.view === 'datamanager') this.loadDMFiles();
    },

    selectBrand(b) {
      this.selectedBrand = b;
      this.brandSearch = b;
      this.showBrandDD = false;
      if (this.brandSubTab === 'dispensary') this.loadBrandReport();
      else this.loadFacingReport();
    },

    switchBrandTab(tab) {
      this.brandSubTab = tab;
      if (tab === 'dispensary' && this.selectedBrand) this.loadBrandReport();
      else if (tab === 'facing' && this.selectedBrand) this.loadFacingReport();
    },

    switchMasterTab(tab) {
      this.masterTab = tab;
      this.loadMasterReport();
    },

    availableYears() {
      return [...new Set(this.periods.map(p => p.year))].sort((a,b)=>b-a);
    },

    monthAbbr(m) { return MO[m - 1]; },

    monthClass(y, m) {
      if (!this.hasData(y, m)) return 'no-data';
      if (this.isSelected(y, m)) return 'selected';
      if (this.isInRange(y, m)) return 'in-range';
      return '';
    },

    pickMonth(y, m) { this.clickMonth(y, m); },

    isPresetActive(p) {
      if (p.type === 'all' && this.periodType === 'all') return true;
      if (!this.pickStart) return p.type === 'all';
      return false;
    },

    applyPreset(p) { this.selectPreset(p.type); },

    periodQuery() {
      const p = this.periodParams();
      const parts = Object.entries(p).filter(([k,v]) => v != null && v !== '').map(([k,v]) => k+'='+encodeURIComponent(v));
      return parts.length ? '?' + parts.join('&') : '';
    },

    findStore(data, name) {
      if (!data?.stores || !name) return null;
      return data.stores.find(s => s.name === name) || null;
    },

    _normalizeBrandReport(d) {
      if (!d || d.error) return d;
      d.kpis = d.summary || d.kpis || {};
      d.kpis.revenue = d.kpis.total_revenue ?? d.kpis.revenue;
      d.kpis.margin = d.kpis.overall_margin ?? d.kpis.margin;
      d.kpis.units = d.kpis.total_units ?? d.kpis.units;
      d.kpis.customers = d.kpis.unique_customers ?? d.kpis.customers;
      d.kpis.vs_category_margin_pts = d.kpis.margin_vs_category ?? d.kpis.vs_category_margin_pts;
      d.by_store = (d.store_summary || d.by_store || []).map(s => ({
        ...s, store: s.store || s.store_clean || s.name,
        disc_rate: s.discount_rate ?? s.disc_rate,
      }));
      d.deal_performance = (d.deals || d.deal_performance || []).map(x => ({
        ...x, uses: x.times_used ?? x.uses,
      }));
      if (d.velocity_by_category) {
        d.velocity_by_category = d.velocity_by_category.map(v => ({
          ...v,
          brand_units_day: v.brand_units_per_day ?? v.brand_units_day,
          cat_avg_day: v.category_avg_units_per_day ?? v.cat_avg_day,
          brand_per_unit: v.brand_rev_per_unit ?? v.brand_per_unit,
          cat_per_unit: v.category_rev_per_unit ?? v.cat_per_unit,
          brands_in_cat: v.brands_in_category ?? v.brands_in_cat,
        }));
      }
      return d;
    },

    _normalizeFacingReport(d) {
      if (!d || d.error) return d;
      d.kpis = d.summary || d.kpis || {};
      d.kpis.revenue = d.kpis.total_revenue ?? d.kpis.revenue;
      d.kpis.margin = d.kpis.overall_margin ?? d.kpis.margin;
      d.kpis.units = d.kpis.total_units ?? d.kpis.units;
      d.kpis.full_price_pct = d.kpis.pct_full_price ?? d.kpis.full_price_pct;
      d.kpis.store_coverage = d.kpis.store_coverage || ((d.kpis.stores_present||0) + '/' + ((d.kpis.stores_present||0) + (d.kpis.stores_missing||0)));
      d.distribution_scorecard = (d.distribution || d.distribution_scorecard || []).map(s => ({
        ...s, carried: s.carries_brand ?? s.carried, skus: s.sku_count ?? s.skus,
        brand_revenue: s.revenue ?? s.brand_revenue, brand_share: s.brand_share_pct ?? s.brand_share,
      }));
      d.store_gap_analysis = d.store_gaps || d.store_gap_analysis || [];
      d.top_products = d.product_mix?.top || d.top_products || [];
      d.sku_expansion = (d.product_mix?.expansion || d.sku_expansion || []).map(s => ({
        ...s, missing_from: s.missing_stores || s.missing_from || [],
      }));
      if (d.pricing_consistency) {
        d.pricing_consistency = d.pricing_consistency.map(p => ({
          ...p, stores: p.store_count ?? p.stores, min: p.min_price ?? p.min,
          max: p.max_price ?? p.max, avg: p.avg_price ?? p.avg,
        }));
      }
      return d;
    },

    _normalizeMaster(d, tab) {
      if (!d || d.error) return d;
      if (tab === 'margin') {
        d.kpis = d.totals || d.kpis || {};
        d.kpis.revenue = d.kpis.total_revenue ?? d.kpis.revenue;
        d.kpis.fp_margin = d.kpis.full_price_margin ?? d.kpis.fp_margin;
        d.kpis.disc_margin = d.kpis.discounted_margin ?? d.kpis.disc_margin;
        const nm = r => ({ ...r, store: r.name||r.store, category: r.name||r.category, brand: r.name||r.brand,
          revenue: r.total_revenue??r.revenue, units: r.total_units??r.units, fp_pct: r.pct_full_price??r.fp_pct,
          fp_margin: r.full_price_margin??r.fp_margin, disc_margin: r.discounted_margin??r.disc_margin,
          blended: r.blended_margin??r.blended, profit: r.net_profit??r.profit });
        d.by_store = (d.by_store||[]).map(nm);
        d.by_category = (d.by_category||[]).map(nm);
        d.top_brands = (d.by_brand||d.top_brands||[]).map(nm).slice(0,30);
      }
      if (tab === 'deals') {
        d.deal_types = (d.deal_types||[]).map(x => ({...x, revenue: x.actual_revenue??x.revenue, disc_rate: x.discount_rate??x.disc_rate, profit: x.net_profit??x.profit}));
      }
      if (tab === 'budtenders') {
        d.kpis = d.summary || d.kpis || {};
        d.rankings = (d.all_rankings||d.rankings||[]).map(b => ({...b, store: b.store_clean||b.store,
          score: b.sales_score??b.score, transactions: b.num_transactions??b.transactions,
          sales: b.total_sales??b.sales, avg_cart: b.avg_cart_value??b.avg_cart,
          units_per_cart: b.avg_units_per_cart??b.units_per_cart, disc_pct: b.pct_sales_discounted??b.disc_pct}));
      }
      if (tab === 'customers') {
        d.kpis = d.summary || d.kpis || {};
        d.kpis.avg_spend = d.kpis.revenue_per_customer ?? d.kpis.avg_spend;
        d.segments = (d.segments||[]).map(s => ({...s, pct_of_customers: s.pct_of_cust??s.pct_of_customers,
          revenue: s.total_revenue??s.revenue, pct_of_revenue: s.pct_of_rev??s.pct_of_revenue,
          revenue_per_customer: s.rev_per_cust??s.revenue_per_customer, disc_rate: s.discount_rate??s.disc_rate}));
        d.top_customers = (d.top_customers||[]).map(c => ({...c, customer: c.customer_name||c.customer,
          store: c.primary_store||c.store, spend: c.total_spent??c.spend, disc_rate: c.discount_rate??c.disc_rate}));
      }
      if (tab === 'rewards') {
        d.kpis = d.summary || d.kpis || {};
        d.kpis.total_redemptions = d.kpis.reward_redemptions ?? d.kpis.total_redemptions;
        d.kpis.net_cost = d.kpis.total_net_cost ?? d.kpis.net_cost;
        d.kpis.markout_employees = d.kpis.employees_using_markouts ?? d.kpis.markout_employees;
        d.kpis.unique_rewards = d.kpis.unique_rewards ?? (d.all_rewards||[]).length;
        d.all_rewards = (d.all_rewards||[]).map(r => ({...r, reward: r.reward_name||r.reward, pct_of_total: r.pct??r.pct_of_total}));
        d.markouts_by_employee = (d.markouts_by_employee||[]).map(e => ({...e, employee: e.customer_name||e.employee, store: e.store_clean||e.store}));
      }
      return d;
    },

    async loadExecSummary() {
      this.loading = true; this.error = null;
      try { this.execData = await this.api('/api/executive-summary', this.periodParams()); }
      catch(e) { this.error = e.message; }
      this.loading = false;
      this.$nextTick(() => this.renderExecCharts());
    },

    async loadMoM() {
      this.loading = true; this.error = null;
      try {
        const raw = await this.api('/api/month-over-month', this.periodParams());
        // Filter to selected date range and rebuild YoY comparison
        if (this.endYear && this.startYear && raw.months) {
          const sYM = this.startYear * 100 + this.startMonth;
          const eYM = this.endYear * 100 + this.endMonth;
          raw.months = raw.months.filter(m => {
            const ym = m.year * 100 + m.month_num;
            return ym >= sYM && ym <= eYM;
          });
          // Rebuild totals from filtered months
          const n = raw.months.length;
          if (n) {
            const tr = raw.months.reduce((s,m) => s + m.revenue, 0);
            const tp = raw.months.reduce((s,m) => s + m.profit, 0);
            raw.totals = {
              revenue: tr, profit: tp,
              units: raw.months.reduce((s,m) => s + m.units, 0),
              transactions: raw.months.reduce((s,m) => s + m.transactions, 0),
              avg_margin: tr ? Math.round(tp / tr * 1000) / 10 : 0,
              avg_full_price_pct: Math.round(raw.months.reduce((s,m) => s + m.full_price_pct, 0) / n * 10) / 10,
            };
            raw.best_month = raw.months.reduce((b,m) => m.revenue > (b.revenue||0) ? m : b, {});
            raw.best_month = {label: raw.best_month.label, revenue: raw.best_month.revenue};
          }
          // Rebuild YoY: pick last two distinct years in filtered range
          const years = [...new Set(raw.months.map(m => m.year))].sort((a,b) => a-b);
          if (years.length >= 2) {
            const y1 = years[years.length - 2], y2 = years[years.length - 1];
            const byYM = {};
            for (const m of raw.months) byYM[m.year * 100 + m.month_num] = m;
            const yoy = [];
            const MN = ['January','February','March','April','May','June','July','August','September','October','November','December'];
            for (let mn = 1; mn <= 12; mn++) {
              const d1 = byYM[y1 * 100 + mn], d2 = byYM[y2 * 100 + mn];
              if (!d1 && !d2) continue;
              yoy.push({
                month_label: MN[mn-1], month_num: mn, y1, y2,
                y1_revenue: d1?.revenue ?? null, y2_revenue: d2?.revenue ?? null,
                y1_profit: d1?.profit ?? null, y2_profit: d2?.profit ?? null,
                y1_margin: d1 ? Math.round(d1.margin*10)/10 : null, y2_margin: d2 ? Math.round(d2.margin*10)/10 : null,
                y1_units: d1?.units ?? null, y2_units: d2?.units ?? null,
                y1_full_price_pct: d1 ? Math.round(d1.full_price_pct*10)/10 : null,
                y2_full_price_pct: d2 ? Math.round(d2.full_price_pct*10)/10 : null,
                revenue_change_pct: d1 && d2 && d1.revenue ? Math.round((d2.revenue - d1.revenue) / d1.revenue * 10000) / 100 : null,
                profit_change_pct: d1 && d2 && d1.profit ? Math.round((d2.profit - d1.profit) / d1.profit * 10000) / 100 : null,
                margin_change_pts: d1 && d2 ? Math.round((d2.margin - d1.margin) * 10) / 10 : null,
                full_price_change_pts: d1 && d2 ? Math.round((d2.full_price_pct - d1.full_price_pct) * 10) / 10 : null,
              });
            }
            raw.yoy_comparison = yoy;
          } else {
            raw.yoy_comparison = [];
          }
        }
        this.momData = raw;
      }
      catch(e) { this.error = e.message; }
      this.loading = false;
      this.$nextTick(() => this.renderMoMCharts());
    },

    async loadStorePerf() {
      this.loading = true; this.error = null;
      try { this.storeData = await this.api('/api/store-performance', this.periodParams()); }
      catch(e) { this.error = e.message; }
      this.loading = false;
      this.$nextTick(() => this.renderStoreCharts());
    },

    async loadYearEnd() {
      this.loading = true; this.error = null;
      try { this.yearEndData = await this.api('/api/year-end-summary', {year: this.yearEndYear}); }
      catch(e) { this.error = e.message; }
      this.loading = false;
      this.$nextTick(() => this.renderYearEndCharts());
    },

    _filterBrandByPeriod(raw) {
      if (!raw || !raw.trend?.length || !this.startYear) return raw;
      const sYM = this.startYear * 100 + this.startMonth;
      const eYM = this.endYear ? this.endYear * 100 + this.endMonth : this.startYear * 100 + this.startMonth;
      raw.trend = raw.trend.filter(t => {
        const [y, m] = t.period.split('-').map(Number);
        const ym = y * 100 + m;
        return ym >= sYM && ym <= eYM;
      });
      const n = raw.trend.length;
      if (n) {
        const s = raw.summary || raw.kpis || {};
        const tr = raw.trend.reduce((a,t) => a + t.revenue, 0);
        const tc = raw.trend.reduce((a,t) => a + t.cost, 0);
        const tp = raw.trend.reduce((a,t) => a + t.profit, 0);
        const tu = raw.trend.reduce((a,t) => a + t.units, 0);
        s.total_revenue = tr;
        s.total_cost = tc;
        s.total_profit = tp;
        s.total_units = tu;
        s.overall_margin = tr ? Math.round(tp / tr * 1000) / 10 : 0;
        s.months_count = n;
        s.avg_monthly_cost = Math.round(tc / n * 100) / 100;
        s.cost_per_unit = tu ? Math.round(tc / tu * 100) / 100 : 0;
        raw.summary = s;
      }
      for (let i = 0; i < raw.trend.length; i++) {
        if (i === 0) {
          raw.trend[i].revenue_change_pct = null;
          raw.trend[i].units_change_pct = null;
          raw.trend[i].margin_change_pts = null;
        } else {
          const prev = raw.trend[i-1], cur = raw.trend[i];
          cur.revenue_change_pct = prev.revenue ? Math.round((cur.revenue - prev.revenue) / prev.revenue * 1000) / 10 : null;
          cur.units_change_pct = prev.units ? Math.round((cur.units - prev.units) / prev.units * 1000) / 10 : null;
          cur.margin_change_pts = Math.round((cur.margin - prev.margin) * 10) / 10;
        }
      }
      return raw;
    },

    async loadBrandReport() {
      if (!this.selectedBrand) return;
      this.loading = true; this.error = null; this.brandReport = null;
      try {
        const raw = await this.api('/api/brands/'+encodeURIComponent(this.selectedBrand)+'/report', this.periodParams());
        this.brandReport = this._normalizeBrandReport(this._filterBrandByPeriod(raw));
      }
      catch(e) { this.error = e.message; }
      this.loading = false;
      this.$nextTick(() => this.renderBrandCharts());
    },

    async loadFacingReport() {
      if (!this.selectedBrand) return;
      this.loading = true; this.error = null; this.facingReport = null;
      try {
        const raw = await this.api('/api/brands/'+encodeURIComponent(this.selectedBrand)+'/facing', this.periodParams());
        this.facingReport = this._normalizeFacingReport(this._filterBrandByPeriod(raw));
      }
      catch(e) { this.error = e.message; }
      this.loading = false;
      this.$nextTick(() => this.renderFacingCharts());
    },

    async loadMasterReport() {
      this.loading = true; this.error = null; this.masterData = null;
      try { this.masterData = this._normalizeMaster(await this.api('/api/master/'+this.masterTab, this.periodParams()), this.masterTab); }
      catch(e) { this.error = e.message; }
      this.loading = false;
    },

    async loadDMFiles() {
      try {
        const res = await this.api('/api/upload/files');
        this.dmFiles = res;
        this.dataFiles = res.files || [];
      } catch(e) { this.error = e.message; }
    },

    _c(id, config) {
      if (this._charts[id]) { this._charts[id].destroy(); delete this._charts[id]; }
      const self = this;
      let attempts = 0;
      function tryRender() {
        const el = document.getElementById(id);
        if (!el) {
          if (++attempts < 10) { setTimeout(tryRender, 100); return; }
          console.error('Chart canvas not found after retries:', id);
          return;
        }
        // Wait until the canvas has actual layout dimensions
        if (el.offsetWidth === 0 && ++attempts < 10) {
          setTimeout(tryRender, 100);
          return;
        }
        try {
          if (typeof Chart === 'undefined') {
            el.parentElement.innerHTML = '<div style="padding:40px;text-align:center;color:#a8555a;font-size:13px">Chart.js failed to load</div>';
            return;
          }
          self._charts[id] = new Chart(el, config);
        } catch(e) {
          console.error('Chart render failed:', id, e);
          el.parentElement.innerHTML = '<div style="padding:40px;text-align:center;color:#a8555a;font-size:13px">Chart error: ' + (e.message||e) + '</div>';
        }
      }
      // Double-defer: nextTick (Alpine DOM) → rAF (browser layout) → render
      requestAnimationFrame(tryRender);
    },

    renderExecCharts() {
      if (!this.execData || this.execData.empty) return;
      const d = this.execData;
      // Monthly Performance combo: revenue bars + margin line
      if (d.monthly_trend?.length) {
        this._c('chart-exec-trend', {
          type: 'bar',
          data: {
            labels: d.monthly_trend.map(m => m.label),
            datasets: [
              { label: 'Revenue', data: d.monthly_trend.map(m => m.revenue), backgroundColor: '#c8956c', borderRadius: 4, order: 2 },
              { label: 'Margin %', data: d.monthly_trend.map(m => m.margin), type: 'line', borderColor: '#22c55e', backgroundColor: 'transparent', yAxisID: 'y1', tension: 0.3, pointRadius: 3, order: 1 },
            ]
          },
          options: { responsive:true, maintainAspectRatio:false, plugins:{legend:{position:'bottom',labels:{boxWidth:12,font:{size:11}}}},
            scales: { y:{ticks:{callback:v=>'$'+(v>=1e6?(v/1e6).toFixed(1)+'M':(v/1e3).toFixed(0)+'K')}}, y1:{position:'right',ticks:{callback:v=>v+'%'},grid:{display:false}} }
          }
        });
      }
      // Top Categories horizontal bar
      if (d.top_categories?.length) {
        this._c('chart-exec-categories', {
          type: 'bar',
          data: { labels: d.top_categories.map(c=>c.name), datasets: [{label:'Revenue',data:d.top_categories.map(c=>c.revenue),backgroundColor:'#c8956c',borderRadius:4}] },
          options: { indexAxis:'y', responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}}, scales:{x:{ticks:{callback:v=>'$'+(v>=1e6?(v/1e6).toFixed(1)+'M':(v/1e3).toFixed(0)+'K')}}} }
        });
      }
      // Top Stores horizontal bar
      if (d.top_stores?.length) {
        this._c('chart-exec-stores', {
          type: 'bar',
          data: { labels: d.top_stores.map(s=>s.name.replace('Thrive Cannabis ','').replace('Thrive ','')), datasets: [{label:'Revenue',data:d.top_stores.map(s=>s.revenue),backgroundColor:'#c8956c',borderRadius:4}] },
          options: { indexAxis:'y', responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}}, scales:{x:{ticks:{callback:v=>'$'+(v>=1e6?(v/1e6).toFixed(1)+'M':(v/1e3).toFixed(0)+'K')}}} }
        });
      }
    },

    renderMoMCharts() {
      // MoM page uses comparison table instead of charts — no canvas to render
    },

    renderStoreCharts() {
      if (!this.storeData || this.storeData.empty) return;
      const s = this.storeData.stores || [];
      const avg = this.storeData.company_avg_margin || 0;
      this._c('chart-store-revenue', {
        type: 'bar',
        data: { labels: s.map(x=>x.name.replace('Thrive Cannabis ','').replace('Thrive ','')),
          datasets: [{label:'Revenue',data:s.map(x=>x.revenue),backgroundColor:s.map(x=>x.margin>=avg?'#22c55e':'#a8555a'),borderRadius:4}] },
        options: { indexAxis:'y', responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}}, scales:{x:{ticks:{callback:v=>'$'+(v>=1e6?(v/1e6).toFixed(1)+'M':(v/1e3).toFixed(0)+'K')}}} }
      });
    },

    renderYearEndCharts() {
      if (!this.yearEndData || this.yearEndData.empty) return;
      const m = this.yearEndData.monthly_summary || [];
      this._c('chart-yearend-trend', {
        type: 'bar',
        data: { labels: m.map(r=>r.label), datasets: [
          {label:'Revenue',data:m.map(r=>r.revenue),backgroundColor:'#c8956c',borderRadius:4,order:2},
          {label:'Margin %',data:m.map(r=>r.margin),type:'line',borderColor:'#22c55e',backgroundColor:'transparent',yAxisID:'y1',tension:0.3,pointRadius:3,order:1}
        ]},
        options: { responsive:true, maintainAspectRatio:false, plugins:{legend:{position:'bottom',labels:{boxWidth:12}}},
          scales:{y:{ticks:{callback:v=>'$'+(v>=1e6?(v/1e6).toFixed(1)+'M':(v/1e3).toFixed(0)+'K')}},y1:{position:'right',ticks:{callback:v=>v+'%'},grid:{display:false}}}
        }
      });
    },

    renderBrandCharts() {
      if (!this.brandReport) return;
      const d = this.brandReport;
      if (d.trend?.length) {
        this._c('chart-brand-trend', {
          type:'line', data:{labels:d.trend.map(t=>t.period),datasets:[
            {label:'Revenue',data:d.trend.map(t=>t.revenue),borderColor:'#c8956c',backgroundColor:'rgba(200,149,108,0.1)',fill:true,tension:0.3,pointRadius:3},
            {label:'Profit',data:d.trend.map(t=>t.profit),borderColor:'#22c55e',borderDash:[5,5],tension:0.3,pointRadius:2}
          ]},
          options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'bottom',labels:{boxWidth:12}}},scales:{y:{ticks:{callback:v=>'$'+(v>=1e6?(v/1e6).toFixed(1)+'M':v>=1e3?(v/1e3).toFixed(0)+'K':v)}}}}
        });
      }
      if (d.category_breakdown?.length) {
        this._c('chart-brand-categories', {type:'doughnut',data:{labels:d.category_breakdown.map(c=>c.category_clean),datasets:[{data:d.category_breakdown.map(c=>c.revenue),backgroundColor:COLORS}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'bottom',labels:{boxWidth:12}}}}});
      }
      if (d.share_of_category?.length) {
        this._c('chart-brand-soc', {type:'bar',data:{labels:d.share_of_category.map(s=>s.category),datasets:[{label:'Revenue Share %',data:d.share_of_category.map(s=>s.revenue_share_pct),backgroundColor:'#c8956c',borderRadius:6},{label:'Units Share %',data:d.share_of_category.map(s=>s.units_share_pct),backgroundColor:'rgba(200,149,108,0.4)',borderRadius:6}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'bottom',labels:{boxWidth:12}}},scales:{y:{ticks:{callback:v=>v+'%'}}}}});
      }
      if (d.discount_depth?.length) {
        this._c('chart-brand-depth', {type:'bar',data:{labels:d.discount_depth.map(x=>x.tier),datasets:[{label:'% of Transactions',data:d.discount_depth.map(x=>x.pct_of_transactions),backgroundColor:COLORS,borderRadius:6}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},scales:{y:{ticks:{callback:v=>v+'%'}}}}});
      }
    },

    renderFacingCharts() {
      if (!this.facingReport) return;
      const d = this.facingReport;
      if (d.share_of_category?.length) {
        this._c('chart-facing-soc', {type:'bar',data:{labels:d.share_of_category.map(s=>s.category),datasets:[{label:'Revenue Share %',data:d.share_of_category.map(s=>s.revenue_share_pct),backgroundColor:'#c8956c',borderRadius:6},{label:'Units Share %',data:d.share_of_category.map(s=>s.units_share_pct),backgroundColor:'rgba(200,149,108,0.4)',borderRadius:6}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'bottom',labels:{boxWidth:12}}},scales:{y:{ticks:{callback:v=>v+'%'}}}}});
      }
      if (d.velocity_by_category?.length) {
        this._c('chart-facing-velocity', {type:'bar',data:{labels:d.velocity_by_category.map(v=>v.category),datasets:[{label:'Brand Units/Day',data:d.velocity_by_category.map(v=>v.brand_units_per_day),backgroundColor:'#c8956c',borderRadius:4},{label:'Category Avg/Day',data:d.velocity_by_category.map(v=>v.category_avg_units_per_day),backgroundColor:'rgba(200,149,108,0.4)',borderRadius:4}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'bottom',labels:{boxWidth:12}}}}});
      }
    },

    async handleFileSelect(event) {
      const files = event.target.files;
      if (files.length) await this.uploadFiles(files);
      event.target.value = '';
    },

    async handleFileDrop(event) {
      const files = event.dataTransfer.files;
      if (files.length) await this.uploadFiles(files);
    },

    async uploadFiles(fileList) {
      this.uploadSuccess = null; this.uploadError = null; this.uploadProgress = 0;
      const csvFiles = [];
      for (const f of fileList) {
        if (f.name.toLowerCase().endsWith('.csv')) csvFiles.push(f);
      }
      if (!csvFiles.length) { this.uploadError = 'No CSV files selected'; this.uploadProgress = null; return; }

      // Chunked upload: split each file into 2MB pieces to avoid Railway proxy timeout
      const CHUNK_SIZE = 2 * 1024 * 1024; // 2MB per chunk

      async function uploadChunk(blob, filename, chunkIndex, totalChunks) {
        const fd = new FormData();
        fd.append('file', blob, `chunk_${chunkIndex}`);
        fd.append('filename', filename);
        fd.append('chunk_index', chunkIndex.toString());
        fd.append('total_chunks', totalChunks.toString());
        const res = await fetch('/api/upload/chunk', { method: 'POST', body: fd });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        return res.json();
      }

      let uploaded = 0;
      let failed = [];
      for (let i = 0; i < csvFiles.length; i++) {
        const f = csvFiles[i];
        const sizeMB = (f.size / 1024 / 1024).toFixed(1);
        const totalChunks = Math.ceil(f.size / CHUNK_SIZE);
        try {
          for (let c = 0; c < totalChunks; c++) {
            const start = c * CHUNK_SIZE;
            const end = Math.min(start + CHUNK_SIZE, f.size);
            const chunk = f.slice(start, end);
            this.uploadProgress = Math.round(((i + c / totalChunks) / csvFiles.length) * 100);
            this.uploadSuccess = `Uploading ${f.name} (${sizeMB}MB) — chunk ${c + 1}/${totalChunks}`;
            await uploadChunk(chunk, f.name, c, totalChunks);
          }
          uploaded++;
          this.uploadSuccess = `Uploaded ${uploaded} of ${csvFiles.length}: ${f.name}`;
        } catch (e) { failed.push(f.name + ': ' + e.message); }
      }

      this.uploadProgress = null;
      this.loadDMFiles();

      const failMsg = failed.length ? ` (${failed.length} failed: ${failed.join(', ')})` : '';
      this.uploadSuccess = `Uploaded ${uploaded} of ${csvFiles.length} file(s)${failMsg}. Click "Reload Data" when you're done uploading all files.`;
    },

    async deleteFile(path) {
      try {
        const r = await fetch('/api/upload/'+encodeURIComponent(path), {method:'DELETE'});
        if (!r.ok) throw new Error(await r.text());
        this.loadDMFiles();
      } catch(e) { this.error = e.message; }
    },

    async reloadData() {
      this.dmReloading = true;
      try {
        const res = await fetch('/api/reload', {method:'POST'});
        if (!res.ok) throw new Error(await res.text());
        const [h, b, s, p] = await Promise.all([
          this.api('/api/health').catch(() => null),
          this.api('/api/brands').catch(() => ({brands:[]})),
          this.api('/api/stores').catch(() => ({stores:[]})),
          this.api('/api/periods').catch(() => ({periods:[]})),
        ]);
        if (h) this.health = h;
        this.brands = b.brands || b || [];
        this.internalBrands = new Set((b.internal_brands || []).map(x => x.toUpperCase()));
        this.stores = s.stores || s || [];
        this.periods = p.periods || p || [];
        this.uploadSuccess = 'Data reloaded: ' + this.fmtN(this.health?.rows) + ' rows, ' + this.stores.length + ' stores';
        this.loadDMFiles();
      } catch(e) { this.uploadError = 'Reload failed: ' + e.message; }
      this.dmReloading = false;
    },

    fmtCurrency(n) {
      if (n == null || isNaN(n)) return '-';
      const abs = Math.abs(n);
      const s = abs >= 1e6 ? '$'+(abs/1e6).toFixed(2)+'M' : '$'+Number(abs).toLocaleString(undefined,{minimumFractionDigits:0,maximumFractionDigits:0});
      return n < 0 ? '-'+s : s;
    },
    fmtN(n) { return n == null || isNaN(n) ? '-' : Number(n).toLocaleString(); },
    fmtPct(n) { return n == null || isNaN(n) ? '-' : Number(n).toFixed(1)+'%'; },
    fmtPctSigned(n) { if (n == null || isNaN(n)) return '-'; return (n > 0 ? '+' : '') + Number(n).toFixed(1) + '%'; },
    marginClass(m) {
      if (m == null || isNaN(m)) return '';
      if (m >= 55) return 'text-success font-semibold';
      if (m >= 50) return 'font-semibold text-[#94a3b8]';
      return 'text-destructive font-semibold';
    },
    formatSize(bytes) {
      if (!bytes) return '-';
      if (bytes < 1024) return bytes + ' B';
      if (bytes < 1024*1024) return (bytes/1024).toFixed(1) + ' KB';
      return (bytes/(1024*1024)).toFixed(1) + ' MB';
    },

  } // end return
} // end dashboard()
</script>
</body>
</html>
